<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Yang's Daily Planner</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
        <!-- TweakCN ÂÆûÊó∂È¢ÑËßàÂäüËÉΩ -->
        <script>
            // TweakCN ÈÖçÁΩÆ - ÂÜÖËÅîÁâàÊú¨
            window.TweakCNConfig = {
                enable: true,
                hotReload: true,
                autoRefresh: true,
                logLevel: "info",
                preview: {
                    fullPageReload: false,
                    preserveScrollPosition: true,
                    highlightChanges: true
                },
                compatibility: {
                    react: true,
                    babel: true,
                    es6: true
                }
            };

            // TweakCN ÂÆûÊó∂È¢ÑËßàÈÖçÁΩÆ
            window.TweakCN = window.TweakCN || window.TweakCNConfig;

            // TweakCN Ready ÂõûË∞É - ‰∏ªÈ¢òÂêåÊ≠•
            window.TweakCNReady = function(tweakcn) {
                console.log('üéâ TweakCN Â∑≤ÂáÜÂ§áÂ∞±Áª™');

                // ÁõëÂê¨ TweakCN ‰∏ªÈ¢òÂèòÂåñ
                if (tweakcn && tweakcn.on && typeof tweakcn.on === 'function') {
                    tweakcn.on('themeChange', function(theme) {
                        console.log('üé® TweakCN ‰∏ªÈ¢òÂàáÊç¢:', theme);
                        if (window.setTheme) {
                            window.setTheme(theme);
                        }
                    });
                }

                // ÁõëÂê¨È°µÈù¢Âà∑Êñ∞‰∫ã‰ª∂
                if (tweakcn && tweakcn.on) {
                    tweakcn.on('beforeRefresh', function() {
                        console.log('üîÑ ÂáÜÂ§áÂà∑Êñ∞È°µÈù¢...');
                    });

                    tweakcn.on('afterRefresh', function() {
                        console.log('‚úÖ È°µÈù¢Âà∑Êñ∞ÂÆåÊàê');
                    });
                }
            };

            // Âä®ÊÄÅÂä†ËΩΩ TweakCN ËÑöÊú¨
            (function () {
                var script = document.createElement("script");
                script.src =
                    "https://cdn.jsdelivr.net/npm/@tweakcn/core@latest/dist/tweakcn.min.js";
                script.async = true;
                script.onload = function () {
                    console.log("‚úÖ TweakCN ÂÆûÊó∂È¢ÑËßàÂ∑≤ÂêØÁî®");
                    if (window.TweakCN && window.TweakCN.init) {
                        window.TweakCN.init();
                    }
                    // Ëß¶Âèë TweakCNReady ÂõûË∞É
                    if (window.TweakCNReady && typeof window.TweakCNReady === 'function') {
                        window.TweakCNReady(window.TweakCN);
                    }
                };
                script.onerror = function () {
                    console.warn("‚ö†Ô∏è TweakCN Âä†ËΩΩÂ§±Ë¥•Ôºå‰ΩÜÂ∫îÁî®‰ªçÂèØÊ≠£Â∏∏‰ΩøÁî®");
                };
                document.head.appendChild(script);
            })();
        </script>
        <link
            href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary: #6c5ce7;
                --primary-light: #a29bfe;
                --secondary: #00cec9;
                --accent-pink: #fd79a8;
                --accent-orange: #fdcb6e;
                --accent-green: #00b894;
                --accent-blue: #74b9ff;
                --accent-red: #e17055;
                --bg-main: #f8f9fe;
                --bg-card: #fff;
                --text-primary: #2d3436;
                --text-secondary: #636e72;
                --text-muted: #b2bec3;
                --shadow-sm: 0 2px 8px rgba(108, 92, 231, 0.08);
                --shadow-md: 0 4px 20px rgba(108, 92, 231, 0.12);
                --radius-sm: 8px;
                --radius-md: 12px;
                --radius-lg: 20px;
                --radius-xl: 28px;
            }

            /* Dark theme support */
            @media (prefers-color-scheme: dark) {
                :root {
                    --primary: #a29bfe;
                    --primary-light: #6c5ce7;
                    --secondary: #00cec9;
                    --accent-pink: #fd79a8;
                    --accent-orange: #fdcb6e;
                    --accent-green: #00b894;
                    --accent-blue: #74b9ff;
                    --accent-red: #ff7675;
                    --bg-main: #1e1e1e;
                    --bg-card: #2d2d2d;
                    --text-primary: #e4e4e7;
                    --text-secondary: #a1a1aa;
                    --text-muted: #71717a;
                    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
                    --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.5);
                }
            }

            /* Theme classes for manual override */
            [data-theme="light"] {
                --primary: #6c5ce7;
                --primary-light: #a29bfe;
                --secondary: #00cec9;
                --accent-pink: #fd79a8;
                --accent-orange: #fdcb6e;
                --accent-green: #00b894;
                --accent-blue: #74b9ff;
                --accent-red: #e17055;
                --bg-main: #f8f9fe;
                --bg-card: #fff;
                --text-primary: #2d3436;
                --text-secondary: #636e72;
                --text-muted: #b2bec3;
                --shadow-sm: 0 2px 8px rgba(108, 92, 231, 0.08);
                --shadow-md: 0 4px 20px rgba(108, 92, 231, 0.12);
            }

            [data-theme="dark"] {
                --primary: #a29bfe;
                --primary-light: #6c5ce7;
                --secondary: #00cec9;
                --accent-pink: #fd79a8;
                --accent-orange: #fdcb6e;
                --accent-green: #00b894;
                --accent-blue: #74b9ff;
                --accent-red: #ff7675;
                --bg-main: #1e1e1e;
                --bg-card: #2d2d2d;
                --text-primary: #e4e4e7;
                --text-secondary: #a1a1aa;
                --text-muted: #71717a;
                --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
                --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.5);
            }

            body {
                font-family: "Quicksand", sans-serif;
                background: var(--bg-main);
                color: var(--text-primary);
                min-height: 100vh;
                margin: 0;
                padding: 0;
                overflow-x: hidden;
            }

            .app-container {
                display: flex;
                min-height: 100vh;
                width: 100%;
            }

            .sidebar {
                width: 280px;
                background: linear-gradient(
                    180deg,
                    var(--primary) 0%,
                    #5b4cd4 100%
                );
                padding: 24px;
                display: flex;
                flex-direction: column;
                position: fixed;
                height: 100vh;
                z-index: 100;
            }

            .logo {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 40px;
                padding: 8px;
            }

            .logo-icon {
                width: 48px;
                height: 48px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: var(--radius-md);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
            }

            .logo-text {
                color: #fff;
                font-family: "Nunito", sans-serif;
                font-weight: 800;
                font-size: 22px;
            }

            .logo-sub {
                color: rgba(255, 255, 255, 0.7);
                font-size: 12px;
                font-weight: 500;
            }

            .nav-menu {
                display: flex;
                flex-direction: column;
                gap: 8px;
                flex: 1;
            }

            .nav-item {
                display: flex;
                align-items: center;
                gap: 14px;
                padding: 14px 18px;
                border-radius: var(--radius-md);
                color: rgba(255, 255, 255, 0.7);
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 600;
                font-size: 15px;
            }

            .nav-item:hover {
                background: rgba(255, 255, 255, 0.1);
                color: #fff;
            }

            .nav-item.active {
                background: rgba(255, 255, 255, 0.2);
                color: #fff;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            .nav-icon {
                font-size: 20px;
                width: 24px;
                text-align: center;
            }

            .user-profile {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: var(--radius-md);
                margin-top: auto;
            }

            .avatar {
                width: 44px;
                height: 44px;
                background: linear-gradient(
                    135deg,
                    var(--accent-pink),
                    var(--accent-orange)
                );
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
                color: #fff;
                font-weight: 700;
            }

            .user-info {
                color: #fff;
            }

            .user-name {
                font-weight: 700;
                font-size: 15px;
            }

            .user-role {
                font-size: 12px;
                opacity: 0.7;
            }

            .main-content {
                flex: 1;
                margin-left: 280px;
                padding: 32px;
                max-width: calc(100vw - 280px);
            }

            .page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 32px;
                flex-wrap: wrap;
                gap: 16px;
            }

            .page-title {
                font-family: "Nunito", sans-serif;
                font-size: 32px;
                font-weight: 800;
                color: var(--text-primary);
            }

            .page-subtitle {
                color: var(--text-secondary);
                font-size: 14px;
                margin-top: 4px;
            }

            .btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 12px 24px;
                border-radius: var(--radius-md);
                font-family: "Quicksand", sans-serif;
                font-weight: 600;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.3s ease;
                border: none;
                outline: none;
            }

            .btn-primary {
                background: linear-gradient(
                    135deg,
                    var(--primary) 0%,
                    #5b4cd4 100%
                );
                color: #fff;
                box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
            }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(108, 92, 231, 0.5);
            }

            .btn-secondary {
                background: #fff;
                color: var(--text-primary);
                border: 2px solid #e8e8f0;
            }

            .btn-secondary:hover {
                border-color: var(--primary);
                color: var(--primary);
            }

            .btn-danger {
                background: var(--accent-red);
                color: #fff;
            }

            .btn-warning {
                background: var(--accent-orange);
                color: #fff;
            }

            .btn-sm {
                padding: 8px 16px;
                font-size: 13px;
            }

            .btn-icon {
                background: none;
                border: none;
                cursor: pointer;
                font-size: 16px;
                padding: 8px;
                border-radius: 50%;
                transition: background 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .btn-icon:hover {
                background: rgba(0, 0, 0, 0.05);
            }

            .btn-icon.delete:hover {
                background: rgba(225, 112, 85, 0.1);
            }

            .card {
                background: var(--bg-card);
                border-radius: var(--radius-lg);
                padding: 24px;
                box-shadow: var(--shadow-sm);
                transition: all 0.3s ease;
            }

            .card:hover {
                box-shadow: var(--shadow-md);
            }

            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }

            .card-title {
                font-family: "Nunito", sans-serif;
                font-size: 18px;
                font-weight: 700;
                color: var(--text-primary);
            }

            .dashboard-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 24px;
                margin-bottom: 32px;
            }

            .stat-card {
                background: var(--bg-card);
                border-radius: var(--radius-lg);
                padding: 24px;
                box-shadow: var(--shadow-sm);
                position: relative;
                overflow: hidden;
            }

            .stat-card::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 4px;
            }

            .stat-card.study::before {
                background: var(--primary);
            }

            .stat-card.entertainment::before {
                background: var(--accent-pink);
            }

            .stat-card.exercise::before {
                background: var(--accent-green);
            }

            .stat-card.social::before {
                background: var(--accent-orange);
            }

            .stat-icon {
                width: 48px;
                height: 48px;
                border-radius: var(--radius-md);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                margin-bottom: 16px;
            }

            .stat-card.study .stat-icon {
                background: rgba(108, 92, 231, 0.1);
            }

            .stat-card.entertainment .stat-icon {
                background: rgba(253, 121, 168, 0.1);
            }

            .stat-card.exercise .stat-icon {
                background: rgba(0, 184, 148, 0.1);
            }

            .stat-card.social .stat-icon {
                background: rgba(253, 203, 110, 0.1);
            }

            .stat-value {
                font-family: "Nunito", sans-serif;
                font-size: 28px;
                font-weight: 800;
                color: var(--text-primary);
                margin-bottom: 4px;
            }

            .stat-label {
                font-size: 14px;
                color: var(--text-secondary);
            }

            .activity-table {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0 8px;
            }

            .activity-table th {
                text-align: left;
                padding: 12px 16px;
                font-size: 12px;
                font-weight: 600;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .activity-table td {
                padding: 16px;
                background: #fafbff;
                font-size: 14px;
            }

            .activity-table tr td:first-child {
                border-radius: var(--radius-md) 0 0 var(--radius-md);
            }

            .activity-table tr td:last-child {
                border-radius: 0 var(--radius-md) var(--radius-md) 0;
            }

            .activity-table input[type="checkbox"] {
                width: 18px;
                height: 18px;
                cursor: pointer;
                accent-color: var(--primary);
                vertical-align: middle;
            }

            .filter-bar {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 12px;
                padding: 16px;
                background: #fafbff;
                border: 1px solid #eef0ff;
                border-radius: var(--radius-lg);
                margin-bottom: 16px;
            }

            .filter-bar input,
            .filter-bar select {
                flex: 1 1 180px;
                min-width: 180px;
                padding: 10px 14px;
                border: 2px solid #e8e8f0;
                border-radius: var(--radius-md);
                font-family: "Quicksand", sans-serif;
                font-size: 14px;
                color: var(--text-primary);
                background: #fff;
                transition: all 0.2s ease;
                outline: none;
            }

            .filter-bar input::placeholder {
                color: var(--text-muted);
            }

            .filter-bar input:focus,
            .filter-bar select:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1);
            }

            .filter-bar select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                padding-right: 40px;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23636e72' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 18px;
            }

            .filter-bar input[type="date"] {
                flex: 0 1 170px;
            }

            .bulk-actions {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                justify-content: space-between;
                gap: 12px;
                padding: 12px 16px;
                margin-bottom: 16px;
                background: #fff;
                border: 1px solid #eef0ff;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-sm);
            }

            .bulk-actions > span {
                color: var(--text-secondary);
                font-size: 14px;
            }

            .category-badge {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .category-study {
                background: rgba(108, 92, 231, 0.1);
                color: var(--primary);
            }

            .category-entertainment {
                background: rgba(253, 121, 168, 0.1);
                color: var(--accent-pink);
            }

            .category-exercise {
                background: rgba(0, 184, 148, 0.1);
                color: var(--accent-green);
            }

            .category-social {
                background: rgba(253, 203, 110, 0.1);
                color: #e17055;
            }

            .category-sleep {
                background: rgba(116, 185, 255, 0.1);
                color: var(--accent-blue);
            }

            .category-other {
                background: rgba(99, 110, 114, 0.1);
                color: var(--text-secondary);
            }

            .status-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
            }

            .status-planning {
                background: rgba(116, 185, 255, 0.15);
                color: #0984e3;
            }

            .status-processing {
                background: rgba(253, 203, 110, 0.15);
                color: #e17055;
            }

            .status-finished {
                background: rgba(0, 184, 148, 0.15);
                color: var(--accent-green);
            }

            .status-partialfinished {
                background: rgba(108, 92, 231, 0.15);
                color: var(--primary);
            }

            .status-abandoned {
                background: rgba(178, 190, 195, 0.15);
                color: var(--text-secondary);
            }

            .mobile-nav {
                display: none;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #fff;
                padding: 12px;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
                z-index: 1000;
                justify-content: space-around;
                align-items: center;
            }

            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 4px;
                color: var(--text-secondary);
                font-size: 10px;
                font-weight: 600;
                text-decoration: none;
                cursor: pointer;
            }

            .mobile-nav-item.active {
                color: var(--primary);
            }

            .mobile-nav-icon {
                font-size: 20px;
            }

            @media (max-width: 768px) {
                .sidebar {
                    display: none;
                }

                .main-content {
                    margin-left: 0 !important;
                    width: 100% !important;
                    max-width: 100% !important;
                    padding: 12px !important;
                    padding-bottom: 90px !important;
                    overflow-x: hidden;
                }

                .app-container {
                    flex-direction: column;
                }

                .dashboard-grid {
                    grid-template-columns: 1fr;
                    gap: 12px;
                }

                .page-header {
                    margin-bottom: 20px;
                    padding: 0 4px;
                }

                .page-title {
                    font-size: 24px;
                }

                .activity-table {
                    display: block;
                }

                .activity-table thead {
                    display: none;
                }

                .activity-table tbody {
                    display: block;
                }

                .activity-table tr {
                    display: flex;
                    flex-wrap: wrap;
                    align-items: center;
                    background: #fff;
                    border: 1px solid #eee;
                    border-radius: var(--radius-md);
                    margin-bottom: 8px;
                    padding: 10px;
                    box-shadow: var(--shadow-sm);
                    gap: 4px;
                    position: relative;
                }

                .activity-table td {
                    display: block;
                    padding: 0;
                    border: none;
                    width: auto;
                }

                .activity-table td[data-label="Select"] {
                    order: 1;
                    margin-right: 8px;
                }

                .activity-table td[data-label="Time"] {
                    order: 2;
                    font-size: 13px;
                    font-weight: 600;
                    color: var(--text-secondary);
                }

                .activity-table td[data-label="Duration"] {
                    order: 3;
                    font-size: 12px;
                    opacity: 0.7;
                    margin-left: 6px;
                }

                .activity-table td[data-label="Date"] {
                    order: 4;
                    margin-left: auto;
                    font-size: 12px;
                    color: #aaa;
                }

                .activity-table td[data-label="Activity"] {
                    order: 10;
                    width: 100%;
                    font-size: 16px;
                    font-weight: 700;
                    color: var(--text-primary);
                    margin: 4px 0 8px;
                }

                .activity-table td[data-label="Category"] {
                    order: 20;
                }

                .activity-table td[data-label="Status"] {
                    order: 21;
                    margin-left: 8px;
                }

                .activity-table td[data-label="Actions"] {
                    order: 30;
                    margin-left: auto;
                }

                .activity-table td::before {
                    display: none !important;
                }

                .activity-table td[data-label="Notes"] {
                    display: none;
                }

                .activity-table .category-badge,
                .activity-table .status-badge {
                    padding: 4px 8px;
                    font-size: 11px;
                }

                .calendar-page-grid {
                    grid-template-columns: 1fr !important;
                    gap: 24px;
                }

                .mobile-nav {
                    display: flex;
                }

                .modal {
                    width: 90vw;
                    max-width: 90vw;
                    padding: 20px;
                    max-height: 90vh;
                    overflow-y: auto;
                }
            }

            .action-btns {
                display: flex;
                gap: 8px;
            }

            .action-btn {
                width: 32px;
                height: 32px;
                border-radius: var(--radius-sm);
                border: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                font-size: 14px;
            }

            .action-btn.edit {
                background: rgba(108, 92, 231, 0.1);
                color: var(--primary);
            }

            .action-btn.delete {
                background: rgba(255, 118, 117, 0.1);
                color: var(--accent-red);
            }

            .action-btn:hover {
                transform: scale(1.1);
            }

            .calendar-page-grid {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 24px;
            }

            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(45, 52, 54, 0.5);
                backdrop-filter: blur(4px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                animation: fadeIn 0.2s ease;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }

            .modal {
                background: #fff;
                border-radius: var(--radius-xl);
                padding: 32px;
                width: 100%;
                max-width: 560px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 8px 40px rgba(108, 92, 231, 0.16);
                animation: slideUp 0.3s ease;
            }

            @keyframes slideUp {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }

                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .modal-title {
                font-family: "Nunito", sans-serif;
                font-size: 24px;
                font-weight: 800;
                margin-bottom: 24px;
                color: var(--text-primary);
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-label {
                display: block;
                font-size: 13px;
                font-weight: 600;
                color: var(--text-secondary);
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .form-input,
            .form-select,
            .form-textarea {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e8e8f0;
                border-radius: var(--radius-md);
                font-family: "Quicksand", sans-serif;
                font-size: 14px;
                transition: all 0.2s ease;
                outline: none;
            }

            .form-input:focus,
            .form-select:focus,
            .form-textarea:focus {
                border-color: var(--primary);
                box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1);
            }

            .form-select {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                padding-right: 40px;
                background-color: #fff;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23636e72' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
                background-repeat: no-repeat;
                background-position: right 12px center;
                background-size: 18px;
            }

            .form-textarea {
                resize: vertical;
                min-height: 80px;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }

            .modal-actions {
                display: flex;
                gap: 12px;
                justify-content: flex-end;
                margin-top: 28px;
                padding-top: 20px;
                border-top: 1px solid #e8e8f0;
            }

            .optimizer-modal {
                max-width: 860px;
            }

            .optimizer-summary {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin: 8px 0 18px;
            }

            .optimizer-chip {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 10px;
                background: #fafbff;
                border: 1px solid #eef0ff;
                border-radius: 999px;
                font-size: 12px;
                color: var(--text-secondary);
            }

            .optimizer-section {
                margin-top: 18px;
            }

            .optimizer-section-title {
                font-family: "Nunito", sans-serif;
                font-size: 14px;
                font-weight: 800;
                text-transform: uppercase;
                letter-spacing: 0.6px;
                color: var(--text-muted);
                margin-bottom: 10px;
            }

            .issue-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .issue-card {
                display: flex;
                gap: 12px;
                align-items: flex-start;
                padding: 14px 16px;
                border-radius: var(--radius-lg);
                background: #fafbff;
                border: 1px solid #eef0ff;
            }

            .issue-badge {
                flex: 0 0 auto;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 28px;
                height: 28px;
                border-radius: 999px;
                font-size: 14px;
                font-weight: 800;
            }

            .issue-badge.info {
                background: rgba(116, 185, 255, 0.18);
                color: #0984e3;
            }

            .issue-badge.warn {
                background: rgba(253, 203, 110, 0.25);
                color: #e17055;
            }

            .issue-badge.error {
                background: rgba(225, 112, 85, 0.2);
                color: #d63031;
            }

            .issue-content {
                flex: 1;
                min-width: 0;
            }

            .issue-title {
                font-weight: 800;
                color: var(--text-primary);
                margin-bottom: 4px;
            }

            .issue-meta {
                font-size: 12px;
                color: var(--text-muted);
                margin-bottom: 6px;
            }

            .issue-details {
                font-size: 13px;
                color: var(--text-secondary);
                line-height: 1.5;
            }

            .issue-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 10px;
            }

            .calendar-container {
                background: var(--bg-card);
                border-radius: var(--radius-lg);
                padding: 24px;
                box-shadow: var(--shadow-sm);
            }

            .calendar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 24px;
            }

            .calendar-nav {
                display: flex;
                align-items: center;
                gap: 16px;
            }

            .calendar-nav-btn {
                width: 40px;
                height: 40px;
                border-radius: var(--radius-sm);
                border: 2px solid #e8e8f0;
                background: #fff;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                transition: all 0.2s ease;
            }

            .calendar-nav-btn:hover {
                border-color: var(--primary);
                color: var(--primary);
            }

            .calendar-title {
                font-family: "Nunito", sans-serif;
                font-size: 20px;
                font-weight: 700;
            }

            .calendar-view-toggle {
                display: flex;
                background: #f5f5fa;
                border-radius: var(--radius-sm);
                padding: 4px;
            }

            .view-toggle-btn {
                padding: 8px 16px;
                border: none;
                background: transparent;
                border-radius: 6px;
                font-family: "Quicksand", sans-serif;
                font-weight: 600;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s ease;
                color: var(--text-secondary);
            }

            .view-toggle-btn.active {
                background: #fff;
                color: var(--primary);
                box-shadow: var(--shadow-sm);
            }

            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 8px;
            }

            .calendar-weekday {
                text-align: center;
                font-size: 12px;
                font-weight: 600;
                color: var(--text-muted);
                padding: 8px;
                text-transform: uppercase;
            }

            .calendar-day {
                aspect-ratio: 1;
                border-radius: var(--radius-md);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease;
                background: #fafbff;
                position: relative;
                min-height: 60px;
            }

            .calendar-day:hover {
                transform: scale(1.05);
                box-shadow: var(--shadow-md);
            }

            .calendar-day.other-month {
                opacity: 0.3;
            }

            .calendar-day.today {
                border: 2px solid var(--primary);
            }

            .calendar-day.selected {
                background: var(--primary);
                color: #fff;
            }

            .calendar-day .day-number {
                font-weight: 600;
                font-size: 14px;
            }

            .calendar-day .health-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                margin-top: 4px;
            }

            .health-excellent {
                background: var(--accent-green);
            }

            .health-good {
                background: var(--accent-blue);
            }

            .health-fair {
                background: var(--accent-orange);
            }

            .health-poor {
                background: var(--accent-red);
            }

            .health-none {
                background: var(--text-muted);
            }

            .year-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 24px;
            }

            .month-card {
                background: #fafbff;
                border-radius: var(--radius-md);
                padding: 16px;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .month-card:hover {
                background: #fff;
                box-shadow: var(--shadow-md);
            }

            .month-name {
                font-weight: 700;
                font-size: 14px;
                margin-bottom: 12px;
                color: var(--text-primary);
            }

            .mini-calendar {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
            }

            .mini-day {
                aspect-ratio: 1;
                border-radius: 4px;
                font-size: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .charts-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 24px;
                margin-bottom: 32px;
            }

            .chart-card {
                background: var(--bg-card);
                border-radius: var(--radius-lg);
                padding: 24px;
                box-shadow: var(--shadow-sm);
            }

            .pie-chart-container {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 20px;
                padding: 10px;
                flex-wrap: wrap;
                flex-direction: column;
            }

            .pie-chart {
                width: 140px;
                height: 140px;
                border-radius: 50%;
                position: relative;
                flex-shrink: 0;
            }

            .pie-chart-inner {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 100px;
                height: 100px;
                background: #fff;
                border-radius: 50%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .pie-chart-total {
                font-family: "Nunito", sans-serif;
                font-size: 24px;
                font-weight: 800;
                color: var(--text-primary);
            }

            .pie-chart-label {
                font-size: 11px;
                color: var(--text-secondary);
            }

            .pie-legend {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .legend-item {
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 13px;
            }

            .legend-color {
                width: 14px;
                height: 14px;
                border-radius: 4px;
            }

            .legend-value {
                color: var(--text-secondary);
                margin-left: auto;
                font-weight: 600;
            }

            .tooltip {
                position: absolute;
                background-color: #fff;
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 12px;
                z-index: 1000;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                width: 400px;
            }

            .tooltip h4 {
                margin-top: 0;
                margin-bottom: 8px;
            }

            .tooltip table {
                width: 100%;
                border-collapse: collapse;
            }

            .tooltip th,
            .tooltip td {
                padding: 4px 8px;
                text-align: left;
            }

            .tooltip th {
                font-size: 12px;
                font-weight: 600;
                color: var(--text-muted);
            }

            .tooltip td {
                font-size: 13px;
            }

            .bar-chart-container {
                padding: 20px 10px;
            }

            .bar-chart-item {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
            }

            .bar-label {
                width: 100px;
                font-size: 13px;
                font-weight: 500;
                color: var(--text-secondary);
            }

            .bar-track {
                flex: 1;
                height: 24px;
                background: #f5f5fa;
                border-radius: 12px;
                overflow: hidden;
            }

            .bar-fill {
                height: 100%;
                border-radius: 12px;
                transition: width 0.5s ease;
                display: flex;
                align-items: center;
                padding-left: 10px;
            }

            .bar-value {
                font-size: 12px;
                font-weight: 600;
                color: #fff;
            }

            .suggestions-card {
                background: linear-gradient(
                    135deg,
                    var(--primary) 0%,
                    #5b4cd4 100%
                );
                border-radius: var(--radius-lg);
                padding: 28px;
                color: #fff;
                margin-top: 24px;
            }

            .suggestions-title {
                font-family: "Nunito", sans-serif;
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .suggestion-item {
                display: flex;
                align-items: flex-start;
                gap: 12px;
                padding: 12px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .suggestion-item:last-child {
                border-bottom: none;
            }

            .suggestion-icon {
                width: 32px;
                height: 32px;
                background: rgba(255, 255, 255, 0.2);
                border-radius: var(--radius-sm);
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }

            .suggestion-text {
                font-size: 14px;
                line-height: 1.5;
                opacity: 0.9;
            }

            /* Dashboard: embed smart suggestions under Health Score */
            .health-suggestions {
                padding: 0 20px 20px;
            }

            .health-suggestions-title {
                font-size: 12px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-muted);
                margin-bottom: 8px;
            }

            .health-suggestions .suggestion-item {
                border-bottom: 1px solid rgba(108, 92, 231, 0.12);
                padding: 10px 0;
            }

            .health-suggestions .suggestion-icon {
                background: rgba(108, 92, 231, 0.12);
            }

            .health-suggestions .suggestion-text {
                color: var(--text-secondary);
                opacity: 1;
            }

            .settings-section {
                background: var(--bg-card);
                border-radius: var(--radius-lg);
                padding: 24px;
                margin-bottom: 24px;
                box-shadow: var(--shadow-sm);
            }

            .settings-title {
                font-family: "Nunito", sans-serif;
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 20px;
                color: var(--text-primary);
            }

            .settings-list {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .settings-item {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 16px;
                background: #fafbff;
                border-radius: var(--radius-md);
                font-size: 14px;
            }

            .settings-item-color {
                width: 12px;
                height: 12px;
                border-radius: 50%;
            }

            .settings-item button {
                background: none;
                border: none;
                cursor: pointer;
                color: var(--text-muted);
                font-size: 16px;
                padding: 0 4px;
                line-height: 1;
            }

            .settings-item button:hover {
                color: var(--accent-red);
            }

            .settings-item button.edit:hover {
                color: var(--primary);
            }

            .settings-item button.delete:hover {
                color: var(--accent-red);
            }

            .add-item-form {
                display: flex;
                gap: 12px;
                margin-top: 16px;
                flex-wrap: wrap;
            }

            .add-item-form input {
                flex: 1;
                min-width: 120px;
                padding: 10px 16px;
                border: 2px solid #e8e8f0;
                border-radius: var(--radius-md);
                font-family: "Quicksand", sans-serif;
                outline: none;
            }

            .add-item-form input:focus {
                border-color: var(--primary);
            }

            .period-selector {
                display: flex;
                background: #f5f5fa;
                border-radius: var(--radius-sm);
                padding: 4px;
                margin-bottom: 24px;
                width: fit-content;
            }

            .period-btn {
                padding: 10px 20px;
                border: none;
                background: transparent;
                border-radius: 6px;
                font-family: "Quicksand", sans-serif;
                font-weight: 600;
                font-size: 14px;
                cursor: pointer;
                transition: all 0.2s ease;
                color: var(--text-secondary);
            }

            .period-btn.active {
                background: #fff;
                color: var(--primary);
                box-shadow: var(--shadow-sm);
            }

            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: var(--text-secondary);
            }

            .empty-icon {
                font-size: 64px;
                margin-bottom: 16px;
                opacity: 0.5;
            }

            .empty-title {
                font-family: "Nunito", sans-serif;
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 8px;
                color: var(--text-primary);
            }

            .health-score-container {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .health-score-circle {
                width: 160px;
                height: 160px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .health-score-inner {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                background: #fff;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }

            .health-score-value {
                font-family: "Nunito", sans-serif;
                font-size: 48px;
                font-weight: 800;
                line-height: 1;
            }

            .health-score-label {
                font-size: 14px;
                color: var(--text-secondary);
                margin-top: 4px;
            }

            .cal-activity {
                padding: 8px 10px;
                background: #fafbff;
                border-radius: var(--radius-sm);
                margin-bottom: 4px;
                cursor: pointer;
                transition: all 0.15s ease;
                border-left: 3px solid transparent;
            }

            .cal-activity:hover {
                background: #f0f1ff;
                transform: translateX(2px);
            }

            .cal-activity-header {
                display: flex;
                align-items: center;
                gap: 6px;
                flex-wrap: nowrap;
            }

            .cal-activity-icon {
                font-size: 14px;
                flex-shrink: 0;
            }

            .cal-activity-title {
                font-weight: 600;
                font-size: 13px;
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                min-width: 0;
            }

            .cal-activity-time {
                font-size: 10px;
                color: var(--text-secondary);
                margin-top: 2px;
            }

            .cal-detail {
                background: #fff;
                border-radius: var(--radius-md);
                padding: 16px;
                margin-bottom: 8px;
                box-shadow: var(--shadow-md);
                animation: slideUp 0.2s ease;
            }

            .cal-detail-title {
                font-family: "Nunito", sans-serif;
                font-size: 16px;
                font-weight: 700;
                margin-bottom: 12px;
            }

            .cal-detail-row {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 13px;
                margin-bottom: 8px;
            }

            .cal-detail-label {
                color: var(--text-secondary);
                min-width: 60px;
            }

            .cal-detail-actions {
                display: flex;
                justify-content: flex-end;
                gap: 8px;
                padding-top: 12px;
                border-top: 1px solid #e8e8f0;
                margin-top: 8px;
            }

            .date-picker-row {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 24px;
                flex-wrap: wrap;
            }

            .date-picker-row input[type="date"] {
                padding: 10px 16px;
                border: 2px solid #e8e8f0;
                border-radius: var(--radius-md);
                font-family: "Quicksand", sans-serif;
                font-size: 14px;
                outline: none;
                cursor: pointer;
            }

            .date-picker-row input[type="date"]:focus {
                border-color: var(--primary);
            }

            .duration-badge {
                display: inline-flex;
                align-items: center;
                gap: 4px;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 600;
                background: rgba(0, 206, 201, 0.15);
                color: #00b894;
            }

            @media (max-width: 1200px) {
                .dashboard-grid {
                    grid-template-columns: repeat(2, 1fr);
                }

                .charts-grid {
                    grid-template-columns: 1fr;
                }
            }

            @media (max-width: 768px) {
                .sidebar {
                    width: 80px;
                    padding: 16px;
                }

                .logo-text,
                .logo-sub,
                .nav-item span,
                .user-info {
                    display: none;
                }

                .main-content {
                    margin-left: 80px;
                    max-width: calc(100vw - 80px);
                }

                .dashboard-grid {
                    grid-template-columns: 1fr;
                }

                .year-grid {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
        </style>
        <script>
            // Theme detection and switching
            (function () {
                // Function to apply theme
                function applyTheme(theme) {
                    document.documentElement.setAttribute("data-theme", theme);
                    console.log("üé® Theme changed to:", theme);
                }

                // Function to detect system theme preference
                function detectSystemTheme() {
                    return window.matchMedia &&
                        window.matchMedia("(prefers-color-scheme: dark)")
                            .matches
                        ? "dark"
                        : "light";
                }

                // Initialize theme on page load
                const savedTheme = localStorage.getItem("yang_theme");
                const systemTheme = detectSystemTheme();
                const initialTheme = savedTheme || systemTheme;
                applyTheme(initialTheme);

                // Listen for system theme changes
                if (window.matchMedia) {
                    window
                        .matchMedia("(prefers-color-scheme: dark)")
                        .addEventListener("change", (e) => {
                            const newTheme = e.matches ? "dark" : "light";
                            applyTheme(newTheme);
                            localStorage.setItem("yang_theme", newTheme);
                        });
                }

                // Expose theme toggle function globally
                window.toggleTheme = function () {
                    const currentTheme =
                        document.documentElement.getAttribute("data-theme") ||
                        "light";
                    const newTheme =
                        currentTheme === "light" ? "dark" : "light";
                    applyTheme(newTheme);
                    localStorage.setItem("yang_theme", newTheme);
                    return newTheme;
                };

                // Expose setTheme function for external control (e.g., TweakCN)
                window.setTheme = function (theme) {
                    if (theme === "light" || theme === "dark") {
                        applyTheme(theme);
                        localStorage.setItem("yang_theme", theme);
                    }
                };

                console.log("‚úÖ Theme system initialized");
            })();
        </script>
    </head>

    <body>
        <div id="root"></div>
        <script type="text/babel">
            const { useState, useEffect, useMemo } = React;
            const APP_VERSION = "v1.7.2";
            const GITHUB_OWNER = "flyzhenghao";
            const GITHUB_REPO = "yang-daily-planner";
            const GITHUB_FILE_PATH = "data.json";
            const GITHUB_BRANCH = "main";

            const defaultCategories = [
                { id: 1, name: "Study", color: "#6C5CE7", icon: "üìö" },
                { id: 2, name: "Entertainment", color: "#FD79A8", icon: "üéÆ" },
                { id: 3, name: "Social", color: "#FDCB6E", icon: "üë•" },
                { id: 4, name: "Exercise", color: "#00B894", icon: "üèÉ" },
                { id: 5, name: "Sleep", color: "#74B9FF", icon: "üò¥" },
                { id: 6, name: "Other", color: "#636E72", icon: "üìå" },
            ];
            const defaultStatuses = [
                { id: 1, name: "Planning", color: "#74B9FF" },
                { id: 2, name: "Processing", color: "#FDCB6E" },
                { id: 3, name: "Finished", color: "#00B894" },
                { id: 4, name: "Partial Finished", color: "#6C5CE7" },
                { id: 5, name: "Abandoned", color: "#B2BEC3" },
            ];

            const getLocalDateStr = (date = new Date()) => {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
            };

            const calcDuration = (timeFrom, timeTo) => {
                if (!timeFrom || !timeTo) return 0;
                const [h1, m1] = timeFrom.split(":").map(Number);
                const [h2, m2] = timeTo.split(":").map(Number);
                let mins = h2 * 60 + m2 - (h1 * 60 + m1);
                if (mins < 0) mins += 24 * 60;
                return mins;
            };

            const timeStrToMins = (time) => {
                if (!time) return null;
                const [h, m] = time.split(":").map(Number);
                return h * 60 + m;
            };

            const formatDuration = (mins) => {
                if (mins <= 0) return "-";
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                if (h > 0 && m > 0) return `${h}h ${m}m`;
                if (h > 0) return `${h}h`;
                return `${m}m`;
            };

            const formatDate = (date) =>
                new Date(date).toLocaleDateString("en-NZ", {
                    year: "numeric",
                    month: "short",
                    day: "numeric",
                });
            const generateId = () =>
                Date.now() + Math.random().toString(36).substr(2, 9);
            const getLS = (key, def) => {
                try {
                    const s = localStorage.getItem(key);
                    return s ? JSON.parse(s) : def;
                } catch {
                    return def;
                }
            };
            const setLS = (key, val) => {
                try {
                    localStorage.setItem(key, JSON.stringify(val));
                } catch (e) {
                    console.error(e);
                }
            };

            const OPTIMIZER_IGNORED_KEY = "yang_optimizer_ignored_issues";

            const minsToTimeStr = (mins) => {
                if (mins == null || Number.isNaN(mins)) return "";
                const m = ((Math.round(mins) % 1440) + 1440) % 1440;
                const h = Math.floor(m / 60);
                const mm = m % 60;
                return `${String(h).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;
            };

            const isOtherCategoryName = (name) => {
                const raw = String(name || "").trim();
                if (!raw) return false;
                if (/other/i.test(raw)) return true;
                if (raw.includes("ÂÖ∂‰ªñ") || raw.includes("ÂÖ∂ÂÆÉ")) return true;
                return false;
            };

            const normalizeTextForMatch = (text) => {
                return String(text || "")
                    .trim()
                    .toLowerCase()
                    .replace(/[\u2014\u2013]/g, "-")
                    .replace(/[^a-z0-9\u4e00-\u9fff]+/g, " ")
                    .replace(/\s+/g, " ")
                    .trim();
            };

            const extractCategoryCandidate = (item) => {
                const raw = String(item || "").trim();
                if (!raw) return null;
                const firstPart = raw.split(/\s*[-‚Äì‚Äî:|>]+\s*/)[0]?.trim();
                if (!firstPart) return null;
                const cleaned = firstPart.replace(/\s+/g, " ").trim();
                if (cleaned.length < 2) return null;
                return cleaned.length > 28
                    ? cleaned.slice(0, 28).trim()
                    : cleaned;
            };

            const buildActivityHistoryIndex = (activities) => {
                const byItem = new Map();
                for (const a of activities || []) {
                    const itemKey = normalizeTextForMatch(a.item);
                    if (!itemKey) continue;
                    const entry = byItem.get(itemKey) || {
                        item: String(a.item || "").trim(),
                        total: 0,
                        categories: new Map(),
                    };
                    entry.total += 1;
                    const cat = String(a.category || "");
                    entry.categories.set(
                        cat,
                        (entry.categories.get(cat) || 0) + 1,
                    );
                    if (
                        a.item &&
                        String(a.item).trim().length >
                            String(entry.item || "").length
                    ) {
                        entry.item = String(a.item).trim();
                    }
                    byItem.set(itemKey, entry);
                }
                return { byItem };
            };

            const buildCategoryKeywordIndex = (categories) => {
                const keywordIndex = new Map();
                for (const c of categories || []) {
                    const name = String(c.name || "");
                    const lower = name.toLowerCase();

                    let keywords = [];
                    if (
                        lower === "study" ||
                        lower.includes("study") ||
                        name.includes("Â≠¶‰π†")
                    ) {
                        keywords = [
                            "study",
                            "homework",
                            "revision",
                            "revise",
                            "read",
                            "reading",
                            "school",
                            "class",
                            "lesson",
                            "tutor",
                            "tuition",
                            "exam",
                            "quiz",
                            "assignment",
                            "project",
                            "research",
                            "coding",
                            "code",
                            "program",
                            "leetcode",
                            "Â≠¶‰π†",
                            "‰Ωú‰∏ö",
                            "Â§ç‰π†",
                            "ÈòÖËØª",
                            "‰∏äËØæ",
                            "Ë°•‰π†",
                            "ËÄÉËØï",
                            "ÊµãÈ™å",
                            "È°πÁõÆ",
                            "ÁºñÁ®ã",
                        ];
                    } else if (
                        lower === "entertainment" ||
                        lower.includes("entertain") ||
                        name.includes("Â®±‰πê")
                    ) {
                        keywords = [
                            "game",
                            "gaming",
                            "youtube",
                            "video",
                            "tv",
                            "movie",
                            "netflix",
                            "tiktok",
                            "music",
                            "play",
                            "fun",
                            "Âä®Êº´",
                            "Ê∏∏Êàè",
                            "ËßÜÈ¢ë",
                            "ÁîµËßÜ",
                            "ÁîµÂΩ±",
                            "Èü≥‰πê",
                            "Â®±‰πê",
                        ];
                    } else if (
                        lower === "social" ||
                        lower.includes("social") ||
                        name.includes("Á§æ‰∫§") ||
                        name.includes("ÊúãÂèã")
                    ) {
                        keywords = [
                            "chat",
                            "call",
                            "meet",
                            "party",
                            "hangout",
                            "family",
                            "friend",
                            "friends",
                            "talk",
                            "social",
                            "dinner",
                            "ËÅö‰ºö",
                            "ËÅäÂ§©",
                            "ÈÄöËØù",
                            "ËßÅÈù¢",
                            "ÊúãÂèã",
                            "ÂÆ∂‰∫∫",
                            "Á§æ‰∫§",
                        ];
                    } else if (
                        lower === "exercise" ||
                        lower.includes("exercise") ||
                        lower.includes("sport") ||
                        name.includes("ËøêÂä®") ||
                        name.includes("ÂÅ•Ë∫´")
                    ) {
                        keywords = [
                            "gym",
                            "run",
                            "running",
                            "walk",
                            "walking",
                            "workout",
                            "exercise",
                            "sport",
                            "training",
                            "swim",
                            "swimming",
                            "basketball",
                            "football",
                            "soccer",
                            "tennis",
                            "yoga",
                            "Ë∑ëÊ≠•",
                            "Êï£Ê≠•",
                            "ÂÅ•Ë∫´",
                            "ËøêÂä®",
                            "ËÆ≠ÁªÉ",
                            "Ê∏∏Ê≥≥",
                            "ÁØÆÁêÉ",
                            "Ë∂≥ÁêÉ",
                            "Áëú‰ºΩ",
                        ];
                    } else if (
                        lower === "sleep" ||
                        lower.includes("sleep") ||
                        name.includes("Áù°")
                    ) {
                        keywords = [
                            "sleep",
                            "nap",
                            "bed",
                            "rest",
                            "wake",
                            "wakeup",
                            "night",
                            "Áù°",
                            "Áù°Ëßâ",
                            "ÂçàÁù°",
                            "‰ºëÊÅØ",
                            "Ëµ∑Â∫ä",
                        ];
                    }

                    const nameNorm = normalizeTextForMatch(name);
                    if (nameNorm) {
                        keywords.push(...nameNorm.split(" ").filter(Boolean));
                    }

                    const deduped = [
                        ...new Set(
                            keywords
                                .map((k) => normalizeTextForMatch(k))
                                .filter((k) => k && k.length >= 2),
                        ),
                    ];
                    keywordIndex.set(name, deduped);
                }
                return keywordIndex;
            };

            const suggestCategoryBySemantic = (
                item,
                categories,
                keywordIndex,
            ) => {
                const itemNorm = normalizeTextForMatch(item);
                if (!itemNorm) return null;
                let best = null;
                for (const c of categories || []) {
                    const name = String(c.name || "");
                    if (isOtherCategoryName(name)) continue;
                    const keywords = keywordIndex.get(name) || [];
                    let score = 0;
                    const matched = [];
                    for (const kw of keywords) {
                        if (itemNorm.includes(kw)) {
                            score += kw.length >= 5 ? 2 : 1;
                            if (matched.length < 3) matched.push(kw);
                        }
                    }
                    if (!best || score > best.score) {
                        best = { category: name, score, matched };
                    }
                }
                if (!best || best.score < 2) return null;
                return best;
            };

            const suggestCategoryByHistory = (item, historyIndex) => {
                const key = normalizeTextForMatch(item);
                if (!key) return null;
                const entry = historyIndex?.byItem?.get(key);
                if (!entry) return null;
                const breakdown = [...entry.categories.entries()]
                    .filter(([name]) => name)
                    .sort((a, b) => b[1] - a[1]);
                if (breakdown.length === 0) return null;
                const [topCategory, topCount] = breakdown[0];
                const confidence = topCount / entry.total;
                return {
                    topCategory,
                    topCount,
                    confidence,
                    total: entry.total,
                    breakdown,
                };
            };

            const intervalOverlapMins = (startA, endA, startB, endB) => {
                return Math.max(
                    0,
                    Math.min(endA, endB) - Math.max(startA, startB),
                );
            };

            const suggestActivityByTimeWindow = (
                windowStartMins,
                windowEndMins,
                historyActivities,
            ) => {
                if (windowStartMins == null || windowEndMins == null)
                    return null;
                if (windowEndMins <= windowStartMins) return null;
                const scores = new Map();

                for (const a of historyActivities || []) {
                    if (!a?.timeFrom || !a?.timeTo || !a?.item) continue;
                    const start = timeStrToMins(a.timeFrom);
                    const endRaw = timeStrToMins(a.timeTo);
                    if (start == null || endRaw == null) continue;

                    let end = endRaw;
                    if (end < start) end += 1440;

                    const itemKey = normalizeTextForMatch(a.item);
                    if (!itemKey) continue;

                    let overlap = 0;
                    overlap += intervalOverlapMins(
                        windowStartMins,
                        windowEndMins,
                        start,
                        Math.min(end, 1440),
                    );
                    if (end > 1440) {
                        overlap += intervalOverlapMins(
                            windowStartMins,
                            windowEndMins,
                            0,
                            end - 1440,
                        );
                    }
                    if (overlap <= 0) continue;

                    const entry = scores.get(itemKey) || {
                        item: String(a.item || "").trim(),
                        count: 0,
                        minutes: 0,
                        categories: new Map(),
                    };
                    entry.count += 1;
                    entry.minutes += overlap;
                    const cat = String(a.category || "");
                    if (cat)
                        entry.categories.set(
                            cat,
                            (entry.categories.get(cat) || 0) + 1,
                        );
                    if (
                        a.item &&
                        String(a.item).trim().length >
                            String(entry.item || "").length
                    ) {
                        entry.item = String(a.item).trim();
                    }
                    scores.set(itemKey, entry);
                }

                if (scores.size === 0) return null;
                const best = [...scores.values()].sort((a, b) => {
                    if (b.count !== a.count) return b.count - a.count;
                    if (b.minutes !== a.minutes) return b.minutes - a.minutes;
                    return String(a.item).localeCompare(String(b.item));
                })[0];
                const topCategory = [
                    ...(best.categories || new Map()).entries(),
                ].sort((a, b) => b[1] - a[1])[0]?.[0];

                return {
                    item: best.item,
                    category: topCategory || "",
                    count: best.count,
                };
            };

            const analyzeActivitiesOptimizer = ({
                scopeActivities,
                historyActivities,
                categories,
                statuses,
                options = {},
            }) => {
                const cfg = {
                    gapMinMins: 30,
                    maxGapsPerDay: 5,
                    historyConfidence: 0.6,
                    minOtherCandidateCount: 3,
                    ...options,
                };

                const issues = [];
                const categoryNamesLower = new Set(
                    (categories || [])
                        .map((c) => normalizeTextForMatch(c.name))
                        .filter(Boolean),
                );
                const otherCategoryNames = new Set(
                    (categories || [])
                        .map((c) => c.name)
                        .filter(isOtherCategoryName)
                        .map((n) => String(n).toLowerCase()),
                );

                const finishedStatusName =
                    (statuses || []).find((s) => /^finished$/i.test(s.name))
                        ?.name || statuses?.[0]?.name;

                const sleepCategoryName =
                    (categories || []).find(
                        (c) =>
                            /^sleep$/i.test(String(c.name || "")) ||
                            String(c.name || "").includes("Áù°"),
                    )?.name || null;

                const historyIndex =
                    buildActivityHistoryIndex(historyActivities);
                const keywordIndex = buildCategoryKeywordIndex(categories);

                // Group scope activities by normalized item
                const scopeByItem = new Map();
                for (const a of scopeActivities || []) {
                    const itemKey = normalizeTextForMatch(a.item);
                    if (!itemKey) continue;
                    if (!scopeByItem.has(itemKey)) scopeByItem.set(itemKey, []);
                    scopeByItem.get(itemKey).push(a);
                }

                // Activity ‚Üî Category checks (history + semantic)
                for (const [itemKey, group] of scopeByItem.entries()) {
                    const displayItem =
                        group.find((x) => x.item && x.item.trim())?.item ||
                        itemKey;

                    const scopeCategoryCounts = new Map();
                    for (const a of group) {
                        const cat = String(a.category || "");
                        scopeCategoryCounts.set(
                            cat,
                            (scopeCategoryCounts.get(cat) || 0) + 1,
                        );
                    }
                    const scopeBreakdown = [
                        ...scopeCategoryCounts.entries(),
                    ].sort((a, b) => b[1] - a[1]);
                    const scopeTopCategory = scopeBreakdown[0]?.[0] || "";

                    const historyRec = suggestCategoryByHistory(
                        displayItem,
                        historyIndex,
                    );
                    const semanticRec = suggestCategoryBySemantic(
                        displayItem,
                        categories,
                        keywordIndex,
                    );

                    const recommendation =
                        historyRec &&
                        historyRec.topCategory &&
                        historyRec.confidence >= cfg.historyConfidence
                            ? {
                                  category: historyRec.topCategory,
                                  source: "history",
                                  confidence: historyRec.confidence,
                              }
                            : semanticRec &&
                                semanticRec.category &&
                                semanticRec.score >= 3
                              ? {
                                    category: semanticRec.category,
                                    source: "semantic",
                                    matched: semanticRec.matched,
                                }
                              : null;

                    const relatedIdsAll = (historyActivities || [])
                        .filter(
                            (a) => normalizeTextForMatch(a?.item) === itemKey,
                        )
                        .map((a) => a.id)
                        .filter(Boolean);

                    if (historyRec && historyRec.breakdown.length > 1) {
                        const breakdownText = historyRec.breakdown
                            .slice(0, 4)
                            .map(([cat, count]) => `${cat} ${count}`)
                            .join(", ");

                        const idsToFix =
                            historyRec.topCategory &&
                            historyRec.confidence >= cfg.historyConfidence
                                ? group
                                      .filter(
                                          (a) =>
                                              a.category !==
                                              historyRec.topCategory,
                                      )
                                      .map((a) => a.id)
                                      .filter(Boolean)
                                : [];

                        const actions = [
                            ...(idsToFix.length > 0
                                ? [
                                      {
                                          kind: "applyCategory",
                                          label: `Apply "${historyRec.topCategory}" to ${idsToFix.length} activities`,
                                          category: historyRec.topCategory,
                                          ids: idsToFix,
                                      },
                                  ]
                                : []),
                            ...(relatedIdsAll.length > 0
                                ? [
                                      {
                                          kind: "bulkEdit",
                                          label: `Manual edit ${relatedIdsAll.length} related activities`,
                                          ids: relatedIdsAll,
                                          title: `Manual edit related: "${displayItem}"`,
                                          defaultCategory:
                                              historyRec.topCategory ||
                                              scopeTopCategory ||
                                              "",
                                      },
                                  ]
                                : []),
                        ];

                        issues.push({
                            id: `hist-${itemKey}`,
                            kind: "category",
                            severity: idsToFix.length > 0 ? "warn" : "info",
                            title: `Category consistency: "${displayItem}"`,
                            meta: `History: ${breakdownText}`,
                            details:
                                idsToFix.length > 0
                                    ? `Recommend "${historyRec.topCategory}" (${Math.round(historyRec.confidence * 100)}% in history).`
                                    : "This activity has been logged under multiple categories in the past.",
                            actions,
                        });
                    } else if (scopeBreakdown.length > 1) {
                        const actions =
                            relatedIdsAll.length > 0
                                ? [
                                      {
                                          kind: "bulkEdit",
                                          label: `Manual edit ${relatedIdsAll.length} related activities`,
                                          ids: relatedIdsAll,
                                          title: `Manual edit related: "${displayItem}"`,
                                          defaultCategory:
                                              scopeTopCategory || "",
                                      },
                                  ]
                                : [];

                        issues.push({
                            id: `scope-${itemKey}`,
                            kind: "category",
                            severity: "warn",
                            title: `Category inconsistent in current view: "${displayItem}"`,
                            meta: `Current view: ${scopeBreakdown
                                .slice(0, 4)
                                .map(([cat, count]) => `${cat} ${count}`)
                                .join(", ")}`,
                            details:
                                "Consider standardizing this activity to a single category.",
                            actions,
                        });
                    }

                    const skipRec =
                        recommendation &&
                        recommendation.source === "history" &&
                        historyRec &&
                        historyRec.breakdown.length > 1;
                    if (
                        !skipRec &&
                        recommendation &&
                        recommendation.category &&
                        scopeTopCategory &&
                        scopeTopCategory !== recommendation.category
                    ) {
                        const idsToFix = group
                            .filter(
                                (a) => a.category !== recommendation.category,
                            )
                            .map((a) => a.id)
                            .filter(Boolean);
                        if (idsToFix.length > 0) {
                            const detail =
                                recommendation.source === "history"
                                    ? `History suggests "${recommendation.category}" (${Math.round((recommendation.confidence || 0) * 100)}% in history).`
                                    : `Semantic match suggests "${recommendation.category}"${
                                          recommendation.matched?.length
                                              ? ` (matched: ${recommendation.matched.join(", ")})`
                                              : ""
                                      }.`;
                            issues.push({
                                id: `rec-${itemKey}`,
                                kind: "category",
                                severity: "info",
                                title: `Category suggestion: "${displayItem}"`,
                                meta: `Current: ${scopeTopCategory}`,
                                details: detail,
                                actions: [
                                    {
                                        kind: "applyCategory",
                                        label: `Apply "${recommendation.category}" to ${idsToFix.length} activities`,
                                        category: recommendation.category,
                                        ids: idsToFix,
                                    },
                                ],
                            });
                        }
                    }

                    const groupHasOther = group.some((a) =>
                        otherCategoryNames.has(
                            String(a.category || "").toLowerCase(),
                        ),
                    );
                    if (
                        groupHasOther &&
                        recommendation &&
                        recommendation.category &&
                        !isOtherCategoryName(recommendation.category)
                    ) {
                        const idsToFix = group
                            .filter((a) =>
                                otherCategoryNames.has(
                                    String(a.category || "").toLowerCase(),
                                ),
                            )
                            .map((a) => a.id)
                            .filter(Boolean);
                        if (idsToFix.length > 0) {
                            issues.push({
                                id: `other-existing-${itemKey}`,
                                kind: "other",
                                severity: "warn",
                                title: `Other looks specific: "${displayItem}"`,
                                meta: `Suggest: ${recommendation.category}`,
                                details:
                                    "This activity is tagged as Other but appears to fit an existing category.",
                                actions: [
                                    {
                                        kind: "applyCategory",
                                        label: `Move ${idsToFix.length} to "${recommendation.category}"`,
                                        category: recommendation.category,
                                        ids: idsToFix,
                                    },
                                ],
                            });
                        }
                    }
                }

                // Suggest new categories for "Other"
                const candidateIndex = new Map();
                for (const a of historyActivities || []) {
                    const catLower = String(a.category || "").toLowerCase();
                    if (!otherCategoryNames.has(catLower)) continue;
                    const candidate = extractCategoryCandidate(a.item);
                    const candidateKey = normalizeTextForMatch(candidate);
                    if (!candidate || !candidateKey) continue;
                    if (isOtherCategoryName(candidate)) continue;
                    if (categoryNamesLower.has(candidateKey)) continue;

                    const entry = candidateIndex.get(candidateKey) || {
                        label: candidate,
                        count: 0,
                        examples: [],
                    };
                    entry.count += 1;
                    if (entry.examples.length < 3 && a.item) {
                        entry.examples.push(a.item);
                    }
                    candidateIndex.set(candidateKey, entry);
                }

                const scopeOther = (scopeActivities || []).filter((a) =>
                    otherCategoryNames.has(
                        String(a.category || "").toLowerCase(),
                    ),
                );
                const scopeOtherByCandidate = new Map();
                for (const a of scopeOther) {
                    const candidate = extractCategoryCandidate(a.item);
                    const key = normalizeTextForMatch(candidate);
                    if (!candidate || !key) continue;
                    const hist = candidateIndex.get(key);
                    if (!hist || hist.count < cfg.minOtherCandidateCount)
                        continue;
                    if (!scopeOtherByCandidate.has(key))
                        scopeOtherByCandidate.set(key, []);
                    scopeOtherByCandidate.get(key).push(a);
                }

                for (const [key, acts] of scopeOtherByCandidate.entries()) {
                    const info = candidateIndex.get(key);
                    const ids = acts.map((a) => a.id).filter(Boolean);
                    issues.push({
                        id: `other-newcat-${key}`,
                        kind: "other",
                        severity: "info",
                        title: `New category candidate`,
                        meta: `Seen ${info.count}√ó under Other (history)`,
                        suggestedName: info.label,
                        details: info.examples.length
                            ? `Examples: ${info.examples.join(" ¬∑ ")}`
                            : "Frequently logged under Other.",
                        actions: [
                            {
                                kind: "createCategory",
                                label: "Create category",
                                defaultName: info.label,
                            },
                            ...(ids.length > 0
                                ? [
                                      {
                                          kind: "applyCategory",
                                          label: `Apply to ${ids.length} activities in view`,
                                          ids,
                                          alsoCreate: true,
                                          defaultName: info.label,
                                      },
                                  ]
                                : []),
                        ],
                    });
                }

                // Time checks per day
                const scopeByDate = new Map();
                for (const a of scopeActivities || []) {
                    const date = String(a.date || "");
                    if (!date) continue;
                    if (!scopeByDate.has(date)) scopeByDate.set(date, []);
                    scopeByDate.get(date).push(a);
                }

                for (const [date, dayActsRaw] of scopeByDate.entries()) {
                    const missingTimeActs = (dayActsRaw || []).filter(
                        (a) => !a.timeFrom || !a.timeTo,
                    );
                    if (missingTimeActs.length > 0) {
                        issues.push({
                            id: `missing-time-${date}`,
                            kind: "time",
                            severity: "info",
                            title: `Missing time fields (${missingTimeActs.length})`,
                            meta: date,
                            details:
                                "Some activities are missing start/end time, so overlap and gap checks may be incomplete.",
                            actions: [],
                        });
                    }

                    const dayActs = (dayActsRaw || []).filter(
                        (a) => a.timeFrom && a.timeTo,
                    );
                    if (dayActs.length === 0) continue;

                    // Duplicate time slots
                    const bySlot = new Map();
                    for (const a of dayActs) {
                        const slotKey = `${a.timeFrom || ""}|${a.timeTo || ""}`;
                        if (!bySlot.has(slotKey)) bySlot.set(slotKey, []);
                        bySlot.get(slotKey).push(a);
                    }
                    const duplicateSlots = [...bySlot.entries()].filter(
                        ([, list]) => list.length > 1,
                    );
                    if (duplicateSlots.length > 0) {
                        issues.push({
                            id: `duplicate-slot-${date}`,
                            kind: "time",
                            severity: "warn",
                            title: `Duplicate time slots (${duplicateSlots.length})`,
                            meta: date,
                            details: duplicateSlots
                                .slice(0, 8)
                                .map(([slot, list]) => {
                                    const [from, to] = slot.split("|");
                                    const names = list
                                        .map((x) => x.item)
                                        .filter(Boolean)
                                        .slice(0, 4)
                                        .join(" ¬∑ ");
                                    return `${from}‚Äì${to}: ${names}${list.length > 4 ? ` (+${list.length - 4} more)` : ""}`;
                                }),
                            actions: [],
                        });
                    }

                    const intervals = [];
                    for (const a of dayActs) {
                        const start = timeStrToMins(a.timeFrom);
                        const endRaw = timeStrToMins(a.timeTo);
                        if (start == null || endRaw == null) continue;
                        let end = endRaw;
                        if (end < start) end += 1440;
                        intervals.push({ a, start, end });

                        if (end === start) {
                            issues.push({
                                id: `zero-duration-${a.id}`,
                                kind: "time",
                                severity: "warn",
                                title: "Zero duration activity",
                                meta: `${date} ${a.timeFrom}‚Äì${a.timeTo}`,
                                details: `"${a.item}" has the same start and end time.`,
                                actions: [],
                            });
                        } else if (end - start < 5) {
                            issues.push({
                                id: `tiny-duration-${a.id}`,
                                kind: "time",
                                severity: "info",
                                title: `Very short activity (${end - start}m)`,
                                meta: `${date} ${a.timeFrom}‚Äì${a.timeTo}`,
                                details: `"${a.item}" might be better merged into a larger block.`,
                                actions: [],
                            });
                        }
                    }

                    intervals.sort((x, y) => x.start - y.start);

                    // Overlaps
                    const overlaps = [];
                    for (let i = 0; i < intervals.length - 1; i++) {
                        const cur = intervals[i];
                        const next = intervals[i + 1];
                        if (next.start < cur.end) overlaps.push({ cur, next });
                    }
                    if (overlaps.length > 0) {
                        overlaps.slice(0, 12).forEach(({ cur, next }) => {
                            const overlapStart = Math.max(
                                cur.start,
                                next.start,
                            );
                            const overlapEnd = Math.min(cur.end, next.end);
                            const overlapMins = Math.max(
                                0,
                                overlapEnd - overlapStart,
                            );
                            const aId = cur.a?.id;
                            const bId = next.a?.id;
                            issues.push({
                                id: `overlap-${date}-${aId || "a"}-${bId || "b"}`,
                                kind: "time",
                                severity: "error",
                                title: `Time overlap (${overlapMins}m)`,
                                meta: `${date} ¬∑ ${cur.a.timeFrom}‚Äì${cur.a.timeTo} vs ${next.a.timeFrom}‚Äì${next.a.timeTo}`,
                                details: `"${cur.a.item}" overlaps "${next.a.item}".`,
                                actions: [
                                    ...(aId
                                        ? [
                                              {
                                                  kind: "editActivity",
                                                  label: `Edit "${cur.a.item}"`,
                                                  activityId: aId,
                                              },
                                          ]
                                        : []),
                                    ...(bId
                                        ? [
                                              {
                                                  kind: "editActivity",
                                                  label: `Edit "${next.a.item}"`,
                                                  activityId: bId,
                                              },
                                          ]
                                        : []),
                                ],
                            });
                        });
                        if (overlaps.length > 12) {
                            issues.push({
                                id: `overlap-more-${date}`,
                                kind: "time",
                                severity: "info",
                                title: "More overlaps not shown",
                                meta: date,
                                details: `${overlaps.length - 12} more overlaps exist. Fix some overlaps and re-run.`,
                                actions: [],
                            });
                        }
                    }

                    // Gaps (00:00‚Äì24:00), including carry-over from previous day
                    const coverageIntervals = intervals.map((it) => ({
                        start: it.start,
                        end: it.end,
                    }));

                    const prevDateObj = new Date(date + "T00:00:00");
                    if (!Number.isNaN(prevDateObj.getTime())) {
                        prevDateObj.setDate(prevDateObj.getDate() - 1);
                        const prevDate = getLocalDateStr(prevDateObj);
                        const prevActs = (historyActivities || []).filter(
                            (a) =>
                                a.date === prevDate && a.timeFrom && a.timeTo,
                        );
                        for (const a of prevActs) {
                            const startPrev = timeStrToMins(a.timeFrom);
                            const endPrev = timeStrToMins(a.timeTo);
                            if (startPrev == null || endPrev == null) continue;
                            if (endPrev < startPrev && endPrev > 0) {
                                coverageIntervals.push({
                                    start: 0,
                                    end: endPrev,
                                });
                            }
                        }
                    }

                    const merged = [];
                    for (const it of coverageIntervals) {
                        const start = Math.max(0, Math.min(it.start, 1440));
                        const end = Math.max(0, Math.min(it.end, 1440));
                        if (end <= start) continue;
                        const last = merged[merged.length - 1];
                        if (!last || start > last.end) {
                            merged.push({ start, end });
                        } else {
                            last.end = Math.max(last.end, end);
                        }
                    }

                    const gaps = [];
                    let cursor = 0;
                    for (const block of merged) {
                        if (block.start > cursor) {
                            gaps.push({ start: cursor, end: block.start });
                        }
                        cursor = Math.max(cursor, block.end);
                    }
                    if (cursor < 1440) gaps.push({ start: cursor, end: 1440 });

                    const bigGaps = gaps
                        .map((g) => ({ ...g, duration: g.end - g.start }))
                        .filter((g) => g.duration >= cfg.gapMinMins);

                    if (bigGaps.length > 0) {
                        const keep = [];
                        for (const g of bigGaps) {
                            if (g.start >= 22 * 60 || g.end <= 7 * 60) {
                                keep.push(g);
                            }
                        }
                        const ranked = [...bigGaps].sort(
                            (a, b) => b.duration - a.duration,
                        );
                        for (const g of ranked) {
                            if (keep.length >= cfg.maxGapsPerDay) break;
                            if (
                                !keep.some(
                                    (k) =>
                                        k.start === g.start && k.end === g.end,
                                )
                            ) {
                                keep.push(g);
                            }
                        }
                        keep.sort((a, b) => a.start - b.start);

                        for (const g of keep) {
                            const from = minsToTimeStr(g.start);
                            const to = minsToTimeStr(g.end);
                            const suggestSleep =
                                g.start >= 22 * 60 || g.end <= 7 * 60;
                            const actions = [];

                            const historySuggestion =
                                suggestActivityByTimeWindow(
                                    g.start,
                                    g.end,
                                    historyActivities,
                                );
                            const suggestedItem =
                                historySuggestion?.item ||
                                (suggestSleep ? "Sleep" : "");
                            const suggestedCategoryRaw =
                                historySuggestion?.category || "";
                            const suggestedCategory =
                                suggestedCategoryRaw &&
                                (categories || []).some(
                                    (c) => c.name === suggestedCategoryRaw,
                                )
                                    ? suggestedCategoryRaw
                                    : suggestSleep && sleepCategoryName
                                      ? sleepCategoryName
                                      : categories?.[0]?.name || "";

                            actions.push({
                                kind: "addActivity",
                                label: suggestedItem
                                    ? `New "${suggestedItem}" ${from}‚Äì${to}`
                                    : `New activity ${from}‚Äì${to}`,
                                prefill: {
                                    date,
                                    timeFrom: from,
                                    timeTo: to,
                                    item: suggestedItem,
                                    category: suggestedCategory,
                                    ...(finishedStatusName
                                        ? { status: finishedStatusName }
                                        : {}),
                                },
                            });
                            if (suggestSleep && sleepCategoryName) {
                                actions.push({
                                    kind: "addActivity",
                                    label: `Add "Sleep" ${from}‚Äì${to}`,
                                    prefill: {
                                        date,
                                        timeFrom: from,
                                        timeTo: to,
                                        item: "Sleep",
                                        category: sleepCategoryName,
                                        ...(finishedStatusName
                                            ? { status: finishedStatusName }
                                            : {}),
                                    },
                                });
                            }
                            issues.push({
                                id: `gap-${date}-${g.start}-${g.end}`,
                                kind: "gap",
                                severity: "info",
                                title: `Gap ${from}‚Äì${to} (${Math.round(g.duration)}m)`,
                                meta: date,
                                details: suggestSleep
                                    ? `Likely Sleep time. Consider adding Sleep for ${from}‚Äì${to}.`
                                    : `Unlogged time. Consider adding an activity for ${from}‚Äì${to}.`,
                                actions,
                            });
                        }
                    }
                }

                const severityOrder = { error: 0, warn: 1, info: 2 };
                issues.sort((a, b) => {
                    const sa = severityOrder[a.severity] ?? 9;
                    const sb = severityOrder[b.severity] ?? 9;
                    if (sa !== sb) return sa - sb;
                    return String(a.meta || "").localeCompare(
                        String(b.meta || ""),
                    );
                });

                return { issues };
            };

            async function loadDataFromGitHub(forceRemote = false) {
                try {
                    const response = await fetch(`data.json?t=${Date.now()}`, {
                        cache: "no-cache",
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const remoteUpdated = data.lastUpdated
                            ? Date.parse(data.lastUpdated)
                            : 0;
                        const localUpdated = getLS("yang_last_updated", 0) || 0;

                        // If forceRemote is true, always use remote data
                        if (
                            !forceRemote &&
                            localUpdated &&
                            localUpdated > remoteUpdated
                        ) {
                            console.log(
                                "üì± Using local data (newer than remote)",
                            );
                            return {
                                activities: getLS("yang_activities", []),
                                categories: getLS(
                                    "yang_categories",
                                    defaultCategories,
                                ),
                                statuses: getLS(
                                    "yang_statuses",
                                    defaultStatuses,
                                ),
                            };
                        }

                        console.log("‚òÅÔ∏è Using remote data from GitHub");
                        if (data.activities)
                            setLS("yang_activities", data.activities);
                        if (data.categories)
                            setLS("yang_categories", data.categories);
                        if (data.statuses)
                            setLS("yang_statuses", data.statuses);
                        setLS("yang_last_updated", remoteUpdated || Date.now());
                        return data;
                    }
                } catch (error) {
                    console.log("Using localStorage fallback");
                }
                return {
                    activities: getLS("yang_activities", []),
                    categories: getLS("yang_categories", defaultCategories),
                    statuses: getLS("yang_statuses", defaultStatuses),
                };
            }

            async function saveDataToGitHub(activities, categories, statuses) {
                const token = localStorage.getItem("yang_github_token");
                if (!token) {
                    console.warn("‚ö†Ô∏è GitHub token not configured");
                    return false;
                }
                try {
                    const dataObj = {
                        version: APP_VERSION,
                        lastUpdated: new Date().toISOString(),
                        activities,
                        categories,
                        statuses,
                    };
                    const content = JSON.stringify(dataObj, null, 2);
                    const encodedContent = btoa(
                        unescape(encodeURIComponent(content)),
                    );
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}?ref=${GITHUB_BRANCH}&t=${Date.now()}`,
                        {
                            headers: {
                                Authorization: `token ${token}`,
                                Accept: "application/vnd.github.v3+json",
                            },
                            cache: "no-cache",
                        },
                    );
                    if (!getResponse.ok)
                        throw new Error(
                            `Failed to get file info: ${getResponse.status}`,
                        );
                    const fileData = await getResponse.json();
                    const updateResponse = await fetch(
                        `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`,
                        {
                            method: "PUT",
                            headers: {
                                Authorization: `token ${token}`,
                                Accept: "application/vnd.github.v3+json",
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                message: `Update data - ${new Date().toISOString()}`,
                                content: encodedContent,
                                sha: fileData.sha,
                                branch: GITHUB_BRANCH,
                            }),
                        },
                    );
                    if (!updateResponse.ok) throw new Error("Failed to save");
                    console.log("‚úÖ Successfully saved to GitHub");
                    return true;
                } catch (error) {
                    console.error("Error saving to GitHub:", error);
                    return false;
                }
            }

            function PieChart({ data, totalLabel, onHover, hoveredCategory }) {
                const total = data.reduce((s, i) => s + i.value, 0);
                if (total === 0)
                    return (
                        <div
                            className="empty-state"
                            style={{ padding: "40px 20px" }}
                        >
                            <div className="empty-icon">üìä</div>
                            <p>No data</p>
                        </div>
                    );
                let parts = [],
                    angle = 0;
                data.forEach((i) => {
                    const a = (i.value / total) * 360;
                    parts.push(`${i.color} ${angle}deg ${angle + a}deg`);
                    angle += a;
                });
                return (
                    <div className="pie-chart-container">
                        <div
                            className="pie-chart"
                            style={{
                                background: `conic-gradient(${parts.join(", ")})`,
                            }}
                        >
                            <div className="pie-chart-inner">
                                <div className="pie-chart-total">
                                    {Math.round(total / 60)}h
                                </div>
                                <div className="pie-chart-label">
                                    {totalLabel || "Total"}
                                </div>
                            </div>
                        </div>
                        <div className="pie-legend">
                            {data.map((i, idx) => (
                                <div
                                    key={idx}
                                    className={`legend-item ${hoveredCategory === i.name ? "hovered" : ""}`}
                                    onMouseEnter={(e) => onHover(i.name, e)}
                                    onMouseLeave={() => onHover(null)}
                                >
                                    <div
                                        className="legend-color"
                                        style={{ background: i.color }}
                                    ></div>
                                    <span>
                                        {i.icon} {i.name}
                                    </span>
                                    <span className="legend-value">
                                        {Math.round(i.value)}m
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            function BarChart({ data }) {
                const max = Math.max(...data.map((d) => d.value), 1);
                if (data.length === 0)
                    return (
                        <div
                            className="empty-state"
                            style={{ padding: "40px 20px" }}
                        >
                            <div className="empty-icon">üìä</div>
                            <p>No data</p>
                        </div>
                    );
                return (
                    <div className="bar-chart-container">
                        {data.map((i, idx) => (
                            <div key={idx} className="bar-chart-item">
                                <div className="bar-label">{i.name}</div>
                                <div className="bar-track">
                                    <div
                                        className="bar-fill"
                                        style={{
                                            width: `${Math.max((i.value / max) * 100, i.value > 0 ? 10 : 0)}%`,
                                            background: i.color,
                                        }}
                                    >
                                        {i.value > 0 && (
                                            <span className="bar-value">
                                                {i.value}
                                            </span>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                );
            }

            function Tooltip({ activities, category, position }) {
                if (!activities || activities.length === 0) return null;

                const sortedActivities = [...activities].sort((a, b) => {
                    return (
                        calcDuration(b.timeFrom, b.timeTo) -
                        calcDuration(a.timeFrom, a.timeTo)
                    );
                });

                return (
                    <div
                        className="tooltip"
                        style={{
                            left: position.x,
                            top: position.y,
                        }}
                    >
                        <h4>{category}</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>Duration</th>
                                    <th>Activity</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {sortedActivities.map((a) => (
                                    <tr key={a.id}>
                                        <td>
                                            {formatDuration(
                                                calcDuration(
                                                    a.timeFrom,
                                                    a.timeTo,
                                                ),
                                            )}
                                        </td>
                                        <td>{a.item}</td>
                                        <td>{a.date}</td>
                                        <td>
                                            {a.timeFrom} - {a.timeTo}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                );
            }

            function App() {
                const [page, setPage] = useState("dashboard");
                const [activities, setActivities] = useState([]);
                const [categories, setCategories] = useState(defaultCategories);
                const [statuses, setStatuses] = useState(defaultStatuses);
                const [showModal, setShowModal] = useState(false);
                const [showTokenModal, setShowTokenModal] = useState(false);
                const [editingActivity, setEditingActivity] = useState(null);
                const [prefillActivity, setPrefillActivity] = useState(null);
                const [selectedDate, setSelectedDate] = useState(new Date());
                const [calendarView, setCalendarView] = useState("month");
                const [period, setPeriod] = useState("daily");
                const [isLoading, setIsLoading] = useState(true);
                const [isSaving, setIsSaving] = useState(false);
                const [isSyncing, setIsSyncing] = useState(false);
                const [confirmConfig, setConfirmConfig] = useState(null);
                const [reportPhoneNumber, setReportPhoneNumber] = useState("");
                const [showReportModal, setShowReportModal] = useState(false);
                const [reportDate, setReportDate] = useState(getLocalDateStr());

                useEffect(() => {
                    setReportPhoneNumber(getLS("yang_report_phone", ""));
                }, []);
                useEffect(() => {
                    setLS("yang_report_phone", reportPhoneNumber);
                }, [reportPhoneNumber]);

                useEffect(() => {
                    loadDataFromGitHub().then((data) => {
                        if (data.activities) setActivities(data.activities);
                        if (data.categories) setCategories(data.categories);
                        if (data.statuses) setStatuses(data.statuses);
                        setIsLoading(false);
                    });
                }, []);
                useEffect(() => {
                    if (!isLoading) {
                        setLS("yang_activities", activities);
                        setLS("yang_last_updated", Date.now());
                    }
                }, [activities, isLoading]);
                useEffect(() => {
                    if (!isLoading) setLS("yang_categories", categories);
                }, [categories, isLoading]);
                useEffect(() => {
                    if (!isLoading) setLS("yang_statuses", statuses);
                }, [statuses, isLoading]);

                const handleSaveToGitHub = async () => {
                    setIsSaving(true);
                    const success = await saveDataToGitHub(
                        activities,
                        categories,
                        statuses,
                    );
                    setIsSaving(false);
                    if (success) alert("‚úÖ Data saved to GitHub successfully!");
                    else {
                        const token = localStorage.getItem("yang_github_token");
                        alert(
                            token
                                ? "‚ùå Failed to save to GitHub."
                                : "‚ö†Ô∏è GitHub token not configured.",
                        );
                    }
                };

                const handleForceSync = async () => {
                    setIsSyncing(true);
                    try {
                        localStorage.removeItem("yang_last_updated");
                        const data = await loadDataFromGitHub(true);
                        if (data.activities) setActivities(data.activities);
                        if (data.categories) setCategories(data.categories);
                        if (data.statuses) setStatuses(data.statuses);
                        alert(
                            `‚úÖ ÂêåÊ≠•ÊàêÂäüÔºÅÂ∑≤‰ªé‰∫ëÁ´ØÂä†ËΩΩ ${data.activities?.length || 0} Êù°Ê¥ªÂä®ËÆ∞ÂΩï„ÄÇ`,
                        );
                    } catch (error) {
                        alert("‚ùå ÂêåÊ≠•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•„ÄÇ");
                    }
                    setIsSyncing(false);
                };

                const addActivity = (a) =>
                    setActivities([...activities, { ...a, id: generateId() }]);
                const updateActivity = (a) =>
                    setActivities(
                        activities.map((x) => (x.id === a.id ? a : x)),
                    );
                const deleteActivity = (id) => {
                    setConfirmConfig({
                        title: "Delete Activity",
                        message:
                            "Are you sure you want to delete this activity?",
                        onConfirm: () => {
                            setActivities((prev) =>
                                prev.filter((a) => a.id !== id),
                            );
                            setConfirmConfig(null);
                            handleSaveToGitHub();
                        },
                    });
                };
                const bulkDeleteActivities = (ids, onSuccess) => {
                    if (!ids || ids.length === 0) return;
                    setConfirmConfig({
                        title: "Bulk Delete",
                        message: `Are you sure you want to delete ${ids.length} activities?`,
                        onConfirm: () => {
                            setActivities((prev) =>
                                prev.filter((a) => !ids.includes(a.id)),
                            );
                            if (onSuccess) onSuccess();
                            setConfirmConfig(null);
                            handleSaveToGitHub();
                        },
                    });
                };
                const bulkUpdateActivities = (ids, updates) => {
                    setActivities((prev) =>
                        prev.map((a) =>
                            ids.includes(a.id) ? { ...a, ...updates } : a,
                        ),
                    );
                    handleSaveToGitHub();
                };
                const createCategory = (name, icon = "üè∑Ô∏è") => {
                    const trimmed = String(name || "").trim();
                    if (!trimmed) return;
                    setCategories((prev) => {
                        if (
                            prev.some(
                                (c) =>
                                    String(c.name || "").toLowerCase() ===
                                    trimmed.toLowerCase(),
                            )
                        ) {
                            return prev;
                        }
                        const color = `#${Math.floor(Math.random() * 16777215)
                            .toString(16)
                            .padStart(6, "0")}`;
                        return [
                            ...prev,
                            {
                                id: generateId(),
                                name: trimmed,
                                icon,
                                color,
                            },
                        ];
                    });
                };

                const openAdd = (prefill = null) => {
                    setEditingActivity(null);
                    setPrefillActivity(prefill);
                    setShowModal(true);
                };
                const openEdit = (a) => {
                    setEditingActivity(a);
                    setPrefillActivity(null);
                    setShowModal(true);
                };

                const closeModal = () => {
                    setShowModal(false);
                    setEditingActivity(null);
                    setPrefillActivity(null);
                };

                const generateDailySummary = (date) => {
                    const today = date;
                    const todayActs = activities.filter(
                        (a) => a.date === today,
                    );
                    if (todayActs.length === 0)
                        return `üìÖ Daily Report [${today}]: No activities logged.`;

                    const finished = todayActs.filter(
                        (a) => a.status === "Finished",
                    );
                    const totalMins = todayActs.reduce(
                        (s, a) => s + calcDuration(a.timeFrom, a.timeTo),
                        0,
                    );
                    const studyMins = todayActs
                        .filter((a) => a.category === "Study")
                        .reduce(
                            (s, a) => s + calcDuration(a.timeFrom, a.timeTo),
                            0,
                        );

                    let text = `üåü *Daily Report - ${formatDate(today)}*\n\n`;
                    text += `üìä *Summary*\n`;
                    text += `‚Ä¢ Total Time: ${formatDuration(totalMins)}\n`;
                    text += `‚Ä¢ Study Time: ${formatDuration(studyMins)}\n`;
                    text += `‚Ä¢ Tasks Completed: ${finished.length}/${todayActs.length}\n\n`;

                    if (finished.length > 0) {
                        text += `‚úÖ *Completed*\n`;
                        finished.forEach((a) => (text += `‚Ä¢ ${a.item}\n`));
                        text += `\n`;
                    }

                    const others = todayActs.filter(
                        (a) => a.status !== "Finished",
                    );
                    if (others.length > 0) {
                        text += `üöß *In Progress / Other*\n`;
                        others.forEach(
                            (a) => (text += `‚Ä¢ ${a.item} (${a.status})\n`),
                        );
                    }

                    return text;
                };

                const handleSendReport = () => {
                    if (!reportPhoneNumber) {
                        alert(
                            "‚ö†Ô∏è Please set a Phone Number in Settings first.",
                        );
                        setPage("settings");
                        return;
                    }
                    setShowReportModal(true);
                };

                const handleConfirmSendReport = (date) => {
                    const text = generateDailySummary(date);
                    const url = `https://wa.me/${reportPhoneNumber.replace(/[^0-9]/g, "")}
?text=${encodeURIComponent(text)}`;
                    window.open(url, "_blank");
                    setShowReportModal(false);
                };

                const navItems = [
                    { id: "dashboard", icon: "üìä", label: "Dashboard" },
                    { id: "activities", icon: "üìù", label: "Activities" },
                    { id: "calendar", icon: "üìÖ", label: "Calendar" },
                    { id: "settings", icon: "‚öôÔ∏è", label: "Settings" },
                ];

                return (
                    <div className="app-container">
                        <aside className="sidebar">
                            <div className="logo">
                                <div className="logo-icon">üåü</div>
                                <div>
                                    <div className="logo-text">
                                        Yang's Planner
                                    </div>
                                    <div className="logo-sub">
                                        Daily Management
                                    </div>
                                </div>
                            </div>
                            <nav className="nav-menu">
                                {navItems.map((i) => (
                                    <div
                                        key={i.id}
                                        className={`nav-item ${page === i.id ? "active" : ""}`}
                                        onClick={() => setPage(i.id)}
                                    >
                                        <span className="nav-icon">
                                            {i.icon}
                                        </span>
                                        <span>{i.label}</span>
                                    </div>
                                ))}
                            </nav>
                            <div
                                style={{
                                    padding: "16px 0",
                                    borderTop:
                                        "1px solid rgba(255,255,255,0.1)",
                                }}
                            >
                                <button
                                    className="btn btn-primary"
                                    onClick={handleSaveToGitHub}
                                    disabled={isSaving}
                                    style={{
                                        width: "100%",
                                        fontSize: "13px",
                                        padding: "10px",
                                    }}
                                >
                                    {isSaving
                                        ? "‚è≥ Saving..."
                                        : "üíæ Save to GitHub"}
                                </button>
                                <button
                                    className="btn btn-secondary"
                                    onClick={handleSendReport}
                                    style={{
                                        width: "100%",
                                        fontSize: "13px",
                                        padding: "10px",
                                        marginTop: "8px",
                                        background: "#25D366",
                                        color: "#fff",
                                        border: "none",
                                    }}
                                >
                                    üì± Send Report
                                </button>
                                <button
                                    className="btn btn-secondary"
                                    onClick={() => setShowTokenModal(true)}
                                    style={{
                                        width: "100%",
                                        fontSize: "13px",
                                        padding: "8px",
                                        marginTop: "8px",
                                    }}
                                >
                                    üîë GitHub Token
                                </button>
                                <div
                                    style={{
                                        fontSize: "10px",
                                        color: "rgba(255,255,255,0.5)",
                                        textAlign: "center",
                                        marginTop: "8px",
                                    }}
                                >
                                    {APP_VERSION}
                                </div>
                            </div>
                            <div className="user-profile">
                                <div className="avatar">Y</div>
                                <div className="user-info">
                                    <div className="user-name">Yang</div>
                                    <div className="user-role">
                                        Year 9 Student
                                    </div>
                                </div>
                            </div>
                        </aside>
                        <main className="main-content">
                            {page === "dashboard" && (
                                <Dashboard
                                    activities={activities}
                                    categories={categories}
                                    statuses={statuses}
                                    onAdd={openAdd}
                                    setPage={setPage}
                                />
                            )}
                            {page === "activities" && (
                                <Activities
                                    activities={activities}
                                    categories={categories}
                                    statuses={statuses}
                                    onAdd={openAdd}
                                    onEdit={openEdit}
                                    onDelete={deleteActivity}
                                    onBulkDelete={bulkDeleteActivities}
                                    onBulkUpdate={bulkUpdateActivities}
                                    onCreateCategory={createCategory}
                                />
                            )}
                            {page === "calendar" && (
                                <Calendar
                                    activities={activities}
                                    categories={categories}
                                    statuses={statuses}
                                    selectedDate={selectedDate}
                                    setSelectedDate={setSelectedDate}
                                    view={calendarView}
                                    setView={setCalendarView}
                                    onAdd={openAdd}
                                    onEdit={openEdit}
                                    onDelete={deleteActivity}
                                />
                            )}
                            {page === "settings" && (
                                <Settings
                                    categories={categories}
                                    setCategories={setCategories}
                                    activities={activities}
                                    setActivities={setActivities}
                                    statuses={statuses}
                                    setStatuses={setStatuses}
                                    onForceSync={handleForceSync}
                                    isSyncing={isSyncing}
                                    reportPhoneNumber={reportPhoneNumber}
                                    setReportPhoneNumber={setReportPhoneNumber}
                                />
                            )}
                        </main>
                        {showModal && (
                            <Modal
                                activity={editingActivity}
                                prefill={prefillActivity}
                                activities={activities}
                                categories={categories}
                                statuses={statuses}
                                onSave={(a, keepOpen) => {
                                    if (editingActivity) {
                                        updateActivity(a);
                                    } else {
                                        addActivity(a);
                                    }
                                    if (!keepOpen) {
                                        closeModal();
                                    }
                                    handleSaveToGitHub();
                                }}
                                onClose={closeModal}
                            />
                        )}
                        {showTokenModal && (
                            <TokenModal
                                onClose={() => setShowTokenModal(false)}
                            />
                        )}
                        {confirmConfig && (
                            <ConfirmModal
                                title={confirmConfig.title}
                                message={confirmConfig.message}
                                onConfirm={confirmConfig.onConfirm}
                                onCancel={() => setConfirmConfig(null)}
                            />
                        )}
                        {showReportModal && (
                            <ReportModal
                                onConfirm={handleConfirmSendReport}
                                onCancel={() => setShowReportModal(false)}
                            />
                        )}
                        <div className="mobile-nav">
                            {navItems.map((item) => (
                                <div
                                    key={item.id}
                                    className={`mobile-nav-item ${page === item.id ? "active" : ""}`}
                                    onClick={() => setPage(item.id)}
                                >
                                    <div className="mobile-nav-icon">
                                        {item.icon}
                                    </div>
                                    <span>{item.label}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            function Dashboard({
                activities,
                categories,
                statuses,
                onAdd,
                setPage,
            }) {
                const [viewDate, setViewDate] = useState(getLocalDateStr());
                const [viewMode, setViewMode] = useState("daily");
                const [hoveredCategory, setHoveredCategory] = useState(null);
                const [tooltipPosition, setTooltipPosition] = useState({
                    x: 0,
                    y: 0,
                });
                const getDateRange = useMemo(() => {
                    const baseDate = new Date(viewDate + "T00:00:00");
                    if (viewMode === "daily")
                        return {
                            start: viewDate,
                            end: viewDate,
                            label: formatDate(viewDate),
                        };
                    if (viewMode === "weekly") {
                        const day = baseDate.getDay();
                        const startD = new Date(baseDate);
                        startD.setDate(baseDate.getDate() - day);
                        const endD = new Date(startD);
                        endD.setDate(startD.getDate() + 6);
                        return {
                            start: getLocalDateStr(startD),
                            end: getLocalDateStr(endD),
                            label: `${formatDate(startD)} - ${formatDate(endD)}`,
                        };
                    }
                    if (viewMode === "monthly") {
                        const startD = new Date(
                            baseDate.getFullYear(),
                            baseDate.getMonth(),
                            1,
                        );
                        const endD = new Date(
                            baseDate.getFullYear(),
                            baseDate.getMonth() + 1,
                            0,
                        );
                        return {
                            start: getLocalDateStr(startD),
                            end: getLocalDateStr(endD),
                            label: `${startD.toLocaleDateString("en-NZ", { month: "long", year: "numeric" })}`,
                        };
                    }
                    const startD = new Date(baseDate.getFullYear(), 0, 1);
                    const endD = new Date(baseDate.getFullYear(), 11, 31);
                    return {
                        start: getLocalDateStr(startD),
                        end: getLocalDateStr(endD),
                        label: `Year ${baseDate.getFullYear()}`,
                    };
                }, [viewDate, viewMode]);
                const filteredActs = useMemo(
                    () =>
                        activities
                            .filter(
                                (a) =>
                                    a.date >= getDateRange.start &&
                                    a.date <= getDateRange.end,
                            )
                            .sort((a, b) => {
                                const dc = b.date.localeCompare(a.date);
                                return dc !== 0
                                    ? dc
                                    : (b.timeFrom || "00:00").localeCompare(
                                          a.timeFrom || "00:00",
                                      );
                            }),
                    [activities, getDateRange],
                );

                const handlePieChartHover = (category, event) => {
                    setHoveredCategory(category);
                    if (event) {
                        setTooltipPosition({
                            x: event.clientX,
                            y: event.clientY,
                        });
                    }
                };

                const stats = useMemo(() => {
                    const cs = categories.map((c) => {
                        const ca = filteredActs.filter(
                            (a) => a.category === c.name,
                        );
                        const mins = ca.reduce(
                            (s, a) => s + calcDuration(a.timeFrom, a.timeTo),
                            0,
                        );
                        return {
                            ...c,
                            activities: ca,
                            minutes: mins,
                            hours: (mins / 60).toFixed(1),
                        };
                    });
                    const totalMins = cs.reduce((s, c) => s + c.minutes, 0);
                    return cs
                        .map((c) => ({
                            ...c,
                            percentage:
                                totalMins > 0
                                    ? ((c.minutes / totalMins) * 100).toFixed(0)
                                    : 0,
                        }))
                        .sort((a, b) => b.minutes - a.minutes);
                }, [filteredActs, categories]);

                const pieData = useMemo(
                    () =>
                        stats
                            .filter((s) => s.minutes > 0)
                            .map((s) => ({
                                name: s.name,
                                value: s.minutes,
                                color: s.color,
                                icon: s.icon,
                            })),
                    [stats],
                );

                const statusStats = useMemo(() => {
                    const ss = statuses.map((s) => ({
                        name: s.name,
                        value: filteredActs.filter((a) => a.status === s.name)
                            .length,
                        color: s.color,
                    }));
                    return ss.filter((s) => s.value > 0);
                }, [filteredActs, statuses]);

                const classifyHealthCategory = (name, icon) => {
                    const raw = String(name || "");
                    const norm = normalizeTextForMatch(raw);
                    const ic = String(icon || "");

                    if (
                        /sleep|nap|rest|bed/.test(norm) ||
                        raw.includes("Áù°") ||
                        raw.includes("‰ºëÊÅØ") ||
                        ic.includes("üò¥") ||
                        ic.includes("üõå")
                    )
                        return "sleep";
                    if (
                        /exercise|workout|gym|run|running|walk|sport|fitness/.test(
                            norm,
                        ) ||
                        raw.includes("ËøêÂä®") ||
                        raw.includes("ÈîªÁÇº") ||
                        raw.includes("ÂÅ•Ë∫´") ||
                        raw.includes("Ë∑ë") ||
                        ic.includes("üèÉ") ||
                        ic.includes("üèã") ||
                        ic.includes("üö¥")
                    )
                        return "exercise";
                    if (
                        /study|learn|learning|read|reading|school|class|course|homework|revision/.test(
                            norm,
                        ) ||
                        raw.includes("Â≠¶‰π†") ||
                        raw.includes("ËØª‰π¶") ||
                        raw.includes("ÈòÖËØª") ||
                        raw.includes("Â§ç‰π†") ||
                        raw.includes("‰Ωú‰∏ö") ||
                        ic.includes("üìö") ||
                        ic.includes("üìù")
                    )
                        return "study";
                    if (
                        /entertainment|fun|game|gaming|video|tv|movie|music|play|social media|tiktok|douyin|bilibili|youtube|netflix/.test(
                            norm,
                        ) ||
                        raw.includes("Â®±‰πê") ||
                        raw.includes("Ê∏∏Êàè") ||
                        raw.includes("ÁîµÂΩ±") ||
                        raw.includes("ÁîµËßÜÂâß") ||
                        raw.includes("Âà∑") ||
                        raw.includes("Êäñ") ||
                        ic.includes("üéÆ") ||
                        ic.includes("üé¨") ||
                        ic.includes("üéµ")
                    )
                        return "entertainment";

                    return null;
                };

                const healthBuckets = useMemo(() => {
                    const totals = {
                        study: 0,
                        exercise: 0,
                        sleep: 0,
                        entertainment: 0,
                    };
                    for (const s of stats || []) {
                        const bucket = classifyHealthCategory(s.name, s.icon);
                        if (!bucket) continue;
                        totals[bucket] += s.minutes || 0;
                    }
                    return totals;
                }, [stats]);

                const healthScore = useMemo(() => {
                    const st = healthBuckets.study || 0;
                    const ex = healthBuckets.exercise || 0;
                    const sl = healthBuckets.sleep || 0;
                    const en = healthBuckets.entertainment || 0;

                    const mult =
                        viewMode === "daily"
                            ? 1
                            : viewMode === "weekly"
                              ? 7
                              : viewMode === "monthly"
                                ? 30
                                : 365;

                    let score = 50;

                    if (st >= 180 * mult * 0.8 && st <= 180 * mult * 1.5) {
                        score += 15;
                    } else if (st >= 180 * mult * 0.5) {
                        score += 10;
                    }

                    if (ex >= 45 * mult * 0.7) score += 15;
                    else if (ex > 0) score += 8;

                    if (sl >= 480 * mult * 0.9 && sl <= 480 * mult * 1.1) {
                        score += 15;
                    } else if (sl >= 480 * mult * 0.8) {
                        score += 10;
                    }

                    if (en > 0 && en <= 120 * mult) score += 5;
                    else if (en > 120 * mult) score -= 5;

                    return Math.min(100, Math.max(0, Math.round(score)));
                }, [healthBuckets, viewMode]);

                const healthTips = useMemo(() => {
                    const tips = [];

                    const st = healthBuckets.study || 0;
                    const ex = healthBuckets.exercise || 0;
                    const en = healthBuckets.entertainment || 0;

                    const mult =
                        viewMode === "daily"
                            ? 1
                            : viewMode === "weekly"
                              ? 7
                              : viewMode === "monthly"
                                ? 30
                                : 365;

                    if (st < 90 * mult) {
                        tips.push({
                            icon: "üìö",
                            text: `Study time is low. Aim for ${((180 * mult) / 60).toFixed(0)}h ${viewMode}.`,
                        });
                    }
                    if (ex < 22 * mult) {
                        tips.push({
                            icon: "üèÉ",
                            text: `Exercise more! Target: ${((45 * mult) / 60).toFixed(1)}h ${viewMode}.`,
                        });
                    }
                    if (en > 180 * mult) {
                        tips.push({
                            icon: "üéÆ",
                            text: "Screen time is high.",
                        });
                    }
                    if (healthScore >= 80) {
                        tips.push({
                            icon: "üåü",
                            text: "Excellent balance!",
                        });
                    }
                    if (tips.length === 0) {
                        tips.push({
                            icon: "‚ú®",
                            text: "Start logging activities!",
                        });
                    }

                    return tips;
                }, [healthBuckets, healthScore, viewMode]);

                const getColor = (score) => {
                    if (score > 80) return "var(--accent-green)";
                    if (score > 60) return "var(--accent-blue)";
                    if (score > 40) return "var(--accent-orange)";
                    return "var(--accent-red)";
                };

                const getGreeting = () => {
                    const h = new Date().getHours();
                    return h < 12
                        ? "Morning"
                        : h < 18
                          ? "Afternoon"
                          : "Evening";
                };
                return (
                    <div>
                        <div className="page-header">
                            <div>
                                <h1 className="page-title">
                                    Good {getGreeting()}, Yang! üëã
                                </h1>
                                <p className="page-subtitle">
                                    {getDateRange.label}
                                </p>
                            </div>
                            <button className="btn btn-primary" onClick={onAdd}>
                                ‚ûï Add Activity
                            </button>
                        </div>
                        <div className="date-picker-row">
                            <input
                                type="date"
                                value={viewDate}
                                onChange={(e) => setViewDate(e.target.value)}
                            />
                            <button
                                className="btn btn-secondary btn-sm"
                                onClick={() => setViewDate(getLocalDateStr())}
                            >
                                Today
                            </button>
                            <div
                                className="period-selector"
                                style={{ marginBottom: 0 }}
                            >
                                {["daily", "weekly", "monthly", "yearly"].map(
                                    (m) => (
                                        <button
                                            key={m}
                                            className={`period-btn ${viewMode === m ? "active" : ""}`}
                                            onClick={() => setViewMode(m)}
                                        >
                                            {m.charAt(0).toUpperCase() +
                                                m.slice(1)}
                                        </button>
                                    ),
                                )}
                            </div>
                        </div>
                        <div className="dashboard-grid">
                            {stats.slice(0, 4).map((s) => (
                                <div
                                    key={s.id}
                                    className={`stat-card ${s.name.toLowerCase()}`}
                                >
                                    <div className="stat-icon">{s.icon}</div>
                                    <div className="stat-value">{s.hours}h</div>
                                    <div className="stat-label">
                                        {s.name} ({s.percentage}%)
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="charts-grid">
                            <div className="chart-card">
                                <div className="card-header">
                                    <h3 className="card-title">
                                        Time by Category
                                    </h3>
                                </div>
                                <PieChart
                                    data={pieData}
                                    totalLabel={viewMode}
                                    onHover={handlePieChartHover}
                                    hoveredCategory={hoveredCategory}
                                />
                            </div>
                            <div className="chart-card">
                                <div className="card-header">
                                    <h3 className="card-title">
                                        Status Distribution
                                    </h3>
                                </div>
                                <BarChart data={statusStats} />
                            </div>
                            <div className="chart-card">
                                <div className="card-header">
                                    <h3 className="card-title">Health Score</h3>
                                </div>
                                <div className="health-score-container">
                                    <div
                                        className="health-score-circle"
                                        style={{
                                            background: `conic-gradient(${getColor(healthScore)} ${healthScore * 3.6}deg, #F5F5FA ${healthScore * 3.6}deg)`,
                                        }}
                                    >
                                        <div className="health-score-inner">
                                            <div
                                                className="health-score-value"
                                                style={{
                                                    color: getColor(
                                                        healthScore,
                                                    ),
                                                }}
                                            >
                                                {healthScore}
                                            </div>
                                            <div className="health-score-label">
                                                / 100
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="health-suggestions">
                                    <div className="health-suggestions-title">
                                        üí° Smart Suggestions
                                    </div>
                                    <div>
                                        {healthTips.map((t, i) => (
                                            <div
                                                key={i}
                                                className="suggestion-item"
                                            >
                                                <div className="suggestion-icon">
                                                    {t.icon}
                                                </div>
                                                <div className="suggestion-text">
                                                    {t.text}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {hoveredCategory && (
                            <Tooltip
                                activities={
                                    stats.find(
                                        (s) => s.name === hoveredCategory,
                                    )?.activities
                                }
                                category={hoveredCategory}
                                position={tooltipPosition}
                            />
                        )}
                        <div className="card">
                            <div className="card-header">
                                <h2 className="card-title">
                                    Recent Activities
                                </h2>
                                <button
                                    className="btn btn-secondary btn-sm"
                                    onClick={() => setPage("activities")}
                                >
                                    View All
                                </button>
                            </div>
                            <Activities
                                activities={activities
                                    .sort(
                                        (a, b) =>
                                            new Date(b.date) -
                                                new Date(a.date) ||
                                            (b.timeFrom || "").localeCompare(
                                                a.timeFrom || "",
                                            ),
                                    )
                                    .slice(0, 5)}
                                categories={categories}
                                statuses={statuses}
                                condensed
                            />
                        </div>
                    </div>
                );
            }

            function Activities({
                activities,
                categories,
                statuses,
                onAdd,
                onEdit,
                onDelete,
                onBulkDelete,
                onBulkUpdate,
                onCreateCategory,
                condensed,
            }) {
                const [filter, setFilter] = useState({
                    text: "",
                    category: "all",
                    status: "all",
                    startDate: "",
                    endDate: "",
                });
                const [sort, setSort] = useState({
                    by: "date",
                    asc: false,
                });
                const [selectedIds, setSelectedIds] = useState([]);
                const [showOptimizer, setShowOptimizer] = useState(false);

                const handleFilterChange = (field, value) => {
                    setFilter({ ...filter, [field]: value });
                };

                const filteredActivities = useMemo(() => {
                    return [...activities]
                        .filter((a) => {
                            const txt = filter.text.toLowerCase();
                            const matchesText =
                                !txt ||
                                a.item.toLowerCase().includes(txt) ||
                                (a.notes &&
                                    a.notes.toLowerCase().includes(txt));
                            const matchesCategory =
                                filter.category === "all" ||
                                a.category === filter.category;
                            const matchesStatus =
                                filter.status === "all" ||
                                a.status === filter.status;
                            const matchesStartDate =
                                !filter.startDate || a.date >= filter.startDate;
                            const matchesEndDate =
                                !filter.endDate || a.date <= filter.endDate;
                            return (
                                matchesText &&
                                matchesCategory &&
                                matchesStatus &&
                                matchesStartDate &&
                                matchesEndDate
                            );
                        })
                        .sort((a, b) => {
                            let res;
                            if (sort.by === "date") {
                                res = new Date(b.date) - new Date(a.date);
                                if (res === 0)
                                    res = (b.timeFrom || "").localeCompare(
                                        a.timeFrom || "",
                                    );
                            } else {
                                res = (a[sort.by] || "").localeCompare(
                                    b[sort.by] || "",
                                );
                            }
                            return sort.asc ? res : -res;
                        });
                }, [activities, filter, sort]);

                const handleSelect = (id) => {
                    if (Array.isArray(id)) {
                        setSelectedIds(id);
                    } else {
                        setSelectedIds((prev) =>
                            prev.includes(id)
                                ? prev.filter((i) => i !== id)
                                : [...prev, id],
                        );
                    }
                };

                if (condensed) {
                    return (
                        <ActivityList
                            activities={activities}
                            categories={categories}
                            statuses={statuses}
                            onEdit={onEdit}
                            condensed
                        />
                    );
                }

                return (
                    <div className="animate-fade-in">
                        {!condensed && (
                            <div className="page-header">
                                <div>
                                    <h1 className="page-title">Activities</h1>
                                    <p className="page-subtitle">
                                        You have {activities.length} logged
                                        activities in total.
                                    </p>
                                </div>
                                <div
                                    style={{
                                        display: "flex",
                                        gap: "12px",
                                        flexWrap: "wrap",
                                    }}
                                >
                                    <button
                                        className="btn btn-secondary"
                                        onClick={() => setShowOptimizer(true)}
                                    >
                                        üß† Optimize
                                    </button>
                                    <button
                                        className="btn btn-primary"
                                        onClick={() => onAdd && onAdd()}
                                    >
                                        ‚ú® Add Activity
                                    </button>
                                </div>
                            </div>
                        )}
                        <div className="card">
                            <div className="filter-bar">
                                <input
                                    type="text"
                                    placeholder="Search..."
                                    value={filter.text}
                                    onChange={(e) =>
                                        handleFilterChange(
                                            "text",
                                            e.target.value,
                                        )
                                    }
                                />
                                <select
                                    value={filter.category}
                                    onChange={(e) =>
                                        handleFilterChange(
                                            "category",
                                            e.target.value,
                                        )
                                    }
                                >
                                    <option value="all">All Categories</option>
                                    {categories.map((c) => (
                                        <option key={c.id} value={c.name}>
                                            {c.icon} {c.name}
                                        </option>
                                    ))}
                                </select>
                                <select
                                    value={filter.status}
                                    onChange={(e) =>
                                        handleFilterChange(
                                            "status",
                                            e.target.value,
                                        )
                                    }
                                >
                                    <option value="all">All Statuses</option>
                                    {statuses.map((s) => (
                                        <option key={s.id} value={s.name}>
                                            {s.name}
                                        </option>
                                    ))}
                                </select>
                                <input
                                    type="date"
                                    value={filter.startDate}
                                    onChange={(e) =>
                                        handleFilterChange(
                                            "startDate",
                                            e.target.value,
                                        )
                                    }
                                />
                                <input
                                    type="date"
                                    value={filter.endDate}
                                    onChange={(e) =>
                                        handleFilterChange(
                                            "endDate",
                                            e.target.value,
                                        )
                                    }
                                />
                            </div>

                            {selectedIds.length > 0 && (
                                <div className="bulk-actions">
                                    <span>
                                        <b>{selectedIds.length}</b> selected
                                    </span>
                                    <button
                                        className="btn btn-sm btn-danger"
                                        onClick={() => {
                                            onBulkDelete(selectedIds, () =>
                                                setSelectedIds([]),
                                            );
                                        }}
                                    >
                                        Delete
                                    </button>
                                    <select
                                        className="form-select"
                                        style={{ width: "auto" }}
                                        onChange={(e) => {
                                            if (e.target.value) {
                                                onBulkUpdate(selectedIds, {
                                                    status: e.target.value,
                                                });
                                                setSelectedIds([]);
                                            }
                                        }}
                                    >
                                        <option value="">Update Status</option>
                                        {statuses.map((s) => (
                                            <option key={s.id} value={s.name}>
                                                {s.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            <ActivityList
                                activities={filteredActivities}
                                onEdit={onEdit}
                                onDelete={onDelete}
                                categories={categories}
                                statuses={statuses}
                                onSelect={handleSelect}
                                selectedIds={selectedIds}
                            />
                        </div>
                        {showOptimizer && (
                            <OptimizerModal
                                scopeActivities={filteredActivities}
                                historyActivities={activities}
                                categories={categories}
                                statuses={statuses}
                                onBulkUpdate={onBulkUpdate}
                                onAdd={onAdd}
                                onEdit={onEdit}
                                onCreateCategory={onCreateCategory}
                                onClose={() => setShowOptimizer(false)}
                            />
                        )}
                    </div>
                );
            }

            function ActivityList({
                activities,
                onEdit,
                onDelete,
                categories,
                statuses,
                condensed = false,
                onSelect,
                selectedIds = [],
            }) {
                const allSelected =
                    !condensed &&
                    selectedIds.length === activities.length &&
                    activities.length > 0;

                const handleSelectAll = (e) => {
                    if (e.target.checked) {
                        onSelect(activities.map((a) => a.id));
                    } else {
                        onSelect([]);
                    }
                };

                if (activities.length === 0 && !condensed) {
                    return (
                        <div className="empty-state">
                            <div className="empty-icon">ü§∑</div>
                            <h3 className="empty-title">
                                No activities found.
                            </h3>
                            <p>Try adjusting your filters.</p>
                        </div>
                    );
                }

                return (
                    <table className="activity-table">
                        {!condensed && (
                            <thead>
                                <tr>
                                    <th style={{ width: "40px" }}>
                                        <input
                                            type="checkbox"
                                            checked={allSelected}
                                            onChange={handleSelectAll}
                                        />
                                    </th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Activity</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                        )}
                        <tbody>
                            {activities.map((a) => (
                                <ActivityRow
                                    key={a.id}
                                    activity={a}
                                    onEdit={onEdit}
                                    onDelete={onDelete}
                                    categories={categories}
                                    statuses={statuses}
                                    condensed={condensed}
                                    onSelect={onSelect}
                                    isSelected={
                                        !condensed && selectedIds.includes(a.id)
                                    }
                                />
                            ))}
                        </tbody>
                    </table>
                );
            }

            function ActivityRow({
                activity: a,
                onEdit,
                onDelete,
                categories,
                statuses,
                condensed,
                onSelect,
                isSelected,
            }) {
                const category = categories.find((c) => c.name === a.category);
                const status = statuses.find((s) => s.name === a.status);
                return (
                    <tr onClick={() => onEdit && onEdit(a)}>
                        {!condensed && (
                            <td
                                data-label="Select"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <input
                                    type="checkbox"
                                    checked={isSelected}
                                    onChange={() => onSelect && onSelect(a.id)}
                                />
                            </td>
                        )}
                        {!condensed && (
                            <td data-label="Date">{formatDate(a.date)}</td>
                        )}
                        <td data-label="Time">
                            {a.timeFrom} - {a.timeTo}
                        </td>
                        <td data-label="Activity">{a.item}</td>
                        <td data-label="Category">
                            <span
                                className={`category-badge category-${a.category?.toLowerCase()}`}
                            >
                                {category?.icon} {a.category}
                            </span>
                        </td>
                        {!condensed && (
                            <td data-label="Status">
                                <span
                                    className={`status-badge status-${a.status?.replace(/ /g, "").toLowerCase()}`}
                                >
                                    {a.status}
                                </span>
                            </td>
                        )}
                        <td data-label="Duration">
                            <span className="duration-badge">
                                {formatDuration(
                                    calcDuration(a.timeFrom, a.timeTo),
                                )}
                            </span>
                        </td>
                        {!condensed && (
                            <td
                                data-label="Actions"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <div className="action-btns">
                                    <button
                                        className="action-btn edit"
                                        onClick={() => onEdit(a)}
                                    >
                                        ‚úèÔ∏è
                                    </button>
                                    <button
                                        className="action-btn delete"
                                        onClick={() => onDelete(a.id)}
                                    >
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </td>
                        )}
                    </tr>
                );
            }

            function Calendar({
                activities,
                categories,
                statuses,
                selectedDate,
                setSelectedDate,
                view,
                setView,
                onAdd,
                onEdit,
                onDelete,
            }) {
                const [currentDate, setCurrentDate] = useState(new Date());

                return (
                    <div className="animate-fade-in">
                        <div className="page-header">
                            <div>
                                <h1 className="page-title">Calendar</h1>
                            </div>
                        </div>
                        <div className="calendar-page-grid">
                            <div className="calendar-container">
                                <CalendarHeader
                                    date={currentDate}
                                    setDate={setCurrentDate}
                                    view={view}
                                    setView={setView}
                                />
                                {view === "month" ? (
                                    <CalendarMonthView
                                        date={currentDate}
                                        activities={activities}
                                        onDayClick={setCurrentDate}
                                    />
                                ) : (
                                    <CalendarYearView
                                        date={currentDate}
                                        activities={activities}
                                        onMonthClick={(month) => {
                                            const newDate = new Date(
                                                currentDate,
                                            );
                                            newDate.setMonth(month);
                                            setCurrentDate(newDate);
                                            setView("month");
                                        }}
                                    />
                                )}
                            </div>
                            <ActivityDetailPanel
                                date={currentDate}
                                activities={activities}
                                categories={categories}
                                onEdit={onEdit}
                            />
                        </div>
                    </div>
                );
            }

            function CalendarHeader({ date, setDate, view, setView }) {
                const changeMonth = (offset) => {
                    const newDate = new Date(date);
                    newDate.setMonth(newDate.getMonth() + offset);
                    setDate(newDate);
                };

                const changeYear = (offset) => {
                    const newDate = new Date(date);
                    newDate.setFullYear(newDate.getFullYear() + offset);
                    setDate(newDate);
                };

                const title =
                    view === "month"
                        ? date.toLocaleDateString("en-US", {
                              year: "numeric",
                              month: "long",
                          })
                        : date.getFullYear();

                return (
                    <div className="calendar-header">
                        <div className="calendar-nav">
                            <button
                                className="calendar-nav-btn"
                                onClick={() =>
                                    view === "month"
                                        ? changeMonth(-1)
                                        : changeYear(-1)
                                }
                            >
                                &lt;
                            </button>
                            <h2 className="calendar-title">{title}</h2>
                            <button
                                className="calendar-nav-btn"
                                onClick={() =>
                                    view === "month"
                                        ? changeMonth(1)
                                        : changeYear(1)
                                }
                            >
                                &gt;
                            </button>
                        </div>
                        <div className="calendar-view-toggle">
                            <button
                                className={`view-toggle-btn ${view === "month" ? "active" : ""}`}
                                onClick={() => setView("month")}
                            >
                                Month
                            </button>
                            <button
                                className={`view-toggle-btn ${view === "year" ? "active" : ""}`}
                                onClick={() => setView("year")}
                            >
                                Year
                            </button>
                        </div>
                    </div>
                );
            }

            function CalendarMonthView({ date, activities, onDayClick }) {
                const monthStart = new Date(
                    date.getFullYear(),
                    date.getMonth(),
                    1,
                );
                const monthEnd = new Date(
                    date.getFullYear(),
                    date.getMonth() + 1,
                    0,
                );
                const startDate = new Date(monthStart);
                startDate.setDate(startDate.getDate() - monthStart.getDay());
                const endDate = new Date(monthEnd);
                endDate.setDate(endDate.getDate() + (6 - monthEnd.getDay()));

                const days = [];
                let d = new Date(startDate);
                while (d <= endDate) {
                    days.push(new Date(d));
                    d.setDate(d.getDate() + 1);
                }

                return (
                    <div className="calendar-grid">
                        {["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map(
                            (day) => (
                                <div key={day} className="calendar-weekday">
                                    {day}
                                </div>
                            ),
                        )}
                        {days.map((day) => {
                            const dayStr = getLocalDateStr(day);
                            const isToday =
                                getLocalDateStr(new Date()) === dayStr;
                            const isSelected = getLocalDateStr(date) === dayStr;
                            const isCurrentMonth =
                                day.getMonth() === date.getMonth();

                            const dayActs = activities.filter(
                                (a) => a.date === dayStr,
                            );

                            let health = "none";
                            if (dayActs.length > 0) {
                                const sleep = dayActs
                                    .filter((a) => a.category === "Sleep")
                                    .reduce(
                                        (s, a) =>
                                            s +
                                            calcDuration(a.timeFrom, a.timeTo),
                                        0,
                                    );
                                if (sleep >= 420) health = "good";
                                else health = "poor";
                            }

                            return (
                                <div
                                    key={dayStr}
                                    className={`calendar-day ${isSelected ? "selected" : ""} ${isToday ? "today" : ""} ${!isCurrentMonth ? "other-month" : ""}`}
                                    onClick={() => onDayClick(day)}
                                >
                                    <span className="day-number">
                                        {day.getDate()}
                                    </span>
                                    <div
                                        className={`health-indicator health-${health}`}
                                    ></div>
                                </div>
                            );
                        })}
                    </div>
                );
            }

            function CalendarYearView({ date, activities, onMonthClick }) {
                return (
                    <div className="year-grid">
                        {Array.from({ length: 12 }).map((_, i) => {
                            const monthDate = new Date(
                                date.getFullYear(),
                                i,
                                1,
                            );
                            const monthActivities = activities.filter((a) =>
                                a.date.startsWith(
                                    `${date.getFullYear()}-${String(i + 1).padStart(2, "0")}`,
                                ),
                            );

                            return (
                                <div
                                    key={i}
                                    className="month-card"
                                    onClick={() => onMonthClick(i)}
                                >
                                    <h4 className="month-name">
                                        {monthDate.toLocaleDateString("en-US", {
                                            month: "long",
                                        })}
                                    </h4>
                                    <MiniCalendar
                                        year={date.getFullYear()}
                                        month={i}
                                        activities={monthActivities}
                                    />
                                </div>
                            );
                        })}
                    </div>
                );
            }

            function MiniCalendar({ year, month, activities }) {
                const monthStart = new Date(year, month, 1);
                const startDate = new Date(monthStart);
                startDate.setDate(startDate.getDate() - startDate.getDay());

                const days = [];
                for (let i = 0; i < 42; i++) {
                    const d = new Date(startDate);
                    d.setDate(d.getDate() + i);
                    days.push(d);
                }

                return (
                    <div className="mini-calendar">
                        {days.map((d, i) => {
                            const dayStr = getLocalDateStr(d);
                            const hasActivity = activities.some(
                                (a) => a.date === dayStr,
                            );
                            let color = "transparent";
                            if (d.getMonth() === month) {
                                color = "#f0f0f0";
                                if (hasActivity) color = "var(--primary-light)";
                            }
                            return (
                                <div
                                    key={i}
                                    className="mini-day"
                                    style={{ backgroundColor: color }}
                                />
                            );
                        })}
                    </div>
                );
            }

            function ActivityDetailPanel({
                date,
                activities,
                categories,
                onEdit,
            }) {
                const [activeId, setActiveId] = useState(null);
                const dayActs = activities.filter(
                    (a) => a.date === getLocalDateStr(date),
                );

                return (
                    <div className="card" style={{ height: "fit-content" }}>
                        <h3 className="card-title">
                            {formatDate(date)} ({dayActs.length})
                        </h3>
                        {dayActs.length === 0 ? (
                            <p>No activities.</p>
                        ) : (
                            dayActs.map((a) => {
                                const category = categories.find(
                                    (c) => c.name === a.category,
                                );
                                return (
                                    <div key={a.id}>
                                        <div
                                            className="cal-activity"
                                            onClick={() =>
                                                setActiveId(
                                                    activeId === a.id
                                                        ? null
                                                        : a.id,
                                                )
                                            }
                                        >
                                            <div className="cal-activity-header">
                                                <span
                                                    className="cal-activity-icon"
                                                    style={{
                                                        color: category?.color,
                                                    }}
                                                >
                                                    {category?.icon}
                                                </span>
                                                <span className="cal-activity-title">
                                                    {a.item}
                                                </span>
                                            </div>
                                            <div className="cal-activity-time">
                                                {a.timeFrom} - {a.timeTo} (
                                                {formatDuration(
                                                    calcDuration(
                                                        a.timeFrom,
                                                        a.timeTo,
                                                    ),
                                                )}
                                                )
                                            </div>
                                        </div>
                                        {activeId === a.id && (
                                            <div className="cal-detail">
                                                <div className="cal-detail-row">
                                                    <span>Status:</span>
                                                    <b>{a.status}</b>
                                                </div>
                                                {a.notes && (
                                                    <div className="cal-detail-row">
                                                        <span>Notes:</span>
                                                        <b>{a.notes}</b>
                                                    </div>
                                                )}
                                                <div className="cal-detail-actions">
                                                    <button
                                                        className="btn btn-sm btn-secondary"
                                                        onClick={() =>
                                                            onEdit(a)
                                                        }
                                                    >
                                                        Edit
                                                    </button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>
                );
            }

            function Settings({
                categories,
                setCategories,
                activities,
                setActivities,
                statuses,
                setStatuses,
                onForceSync,
                isSyncing,
                reportPhoneNumber,
                setReportPhoneNumber,
            }) {
                const [newCat, setNewCat] = useState({ name: "", icon: "üè∑Ô∏è" });
                const [editingCategory, setEditingCategory] = useState(null);
                const [editDraft, setEditDraft] = useState({
                    name: "",
                    icon: "üè∑Ô∏è",
                    color: "#6c5ce7",
                });
                const [deletingCategory, setDeletingCategory] = useState(null);
                const [deleteMoveTo, setDeleteMoveTo] = useState("");

                const makeRandomColor = () =>
                    `#${Math.floor(Math.random() * 16777215)
                        .toString(16)
                        .padStart(6, "0")}`;

                const handleAddCategory = () => {
                    const name = String(newCat.name || "").trim();
                    const icon = String(newCat.icon || "").trim() || "üè∑Ô∏è";
                    if (
                        name &&
                        !categories.some(
                            (c) =>
                                String(c.name || "").toLowerCase() ===
                                name.toLowerCase(),
                        )
                    ) {
                        setCategories([
                            ...categories,
                            {
                                name,
                                icon,
                                id: generateId(),
                                color: makeRandomColor(),
                            },
                        ]);
                        setNewCat({ name: "", icon: "üè∑Ô∏è" });
                    }
                };

                const startEditCategory = (cat) => {
                    if (!cat) return;
                    setEditDraft({
                        name: String(cat.name || "").trim(),
                        icon: String(cat.icon || "").trim() || "üè∑Ô∏è",
                        color: String(cat.color || "").trim() || "#6c5ce7",
                    });
                    setEditingCategory(cat);
                };

                const saveCategoryEdit = () => {
                    if (!editingCategory) return;
                    const nextName = String(editDraft.name || "").trim();
                    const nextIcon =
                        String(editDraft.icon || "").trim() || "üè∑Ô∏è";
                    const nextColor = String(editDraft.color || "").trim();

                    if (!nextName) {
                        alert("Category name cannot be empty.");
                        return;
                    }
                    if (
                        categories.some(
                            (c) =>
                                c.id !== editingCategory.id &&
                                String(c.name || "").toLowerCase() ===
                                    nextName.toLowerCase(),
                        )
                    ) {
                        alert("Category name already exists.");
                        return;
                    }

                    const oldName = editingCategory.name;
                    setCategories((prev) =>
                        prev.map((c) =>
                            c.id === editingCategory.id
                                ? {
                                      ...c,
                                      name: nextName,
                                      icon: nextIcon,
                                      color: nextColor || c.color,
                                  }
                                : c,
                        ),
                    );
                    if (oldName !== nextName && setActivities) {
                        setActivities((prev) =>
                            prev.map((a) =>
                                a.category === oldName
                                    ? { ...a, category: nextName }
                                    : a,
                            ),
                        );
                    }
                    setEditingCategory(null);
                };

                const startDeleteCategory = (cat) => {
                    if (!cat) return;
                    if ((categories || []).length <= 1) {
                        alert("At least one category is required.");
                        return;
                    }

                    const usedCount = (activities || []).filter(
                        (a) => a.category === cat.name,
                    ).length;

                    const fallback =
                        categories.find(
                            (c) =>
                                c.id !== cat.id && isOtherCategoryName(c.name),
                        )?.name ||
                        categories.find((c) => c.id !== cat.id)?.name ||
                        "";

                    setDeletingCategory({ ...cat, usedCount });
                    setDeleteMoveTo(fallback);
                };

                const confirmDeleteCategory = () => {
                    if (!deletingCategory) return;
                    if ((categories || []).length <= 1) {
                        alert("At least one category is required.");
                        return;
                    }

                    const oldName = deletingCategory.name;
                    const usedCount = (activities || []).filter(
                        (a) => a.category === oldName,
                    ).length;
                    const replacement = String(deleteMoveTo || "").trim();

                    if (usedCount > 0 && !replacement) {
                        alert(
                            "Please choose a category to move activities to.",
                        );
                        return;
                    }

                    if (usedCount > 0 && setActivities) {
                        setActivities((prev) =>
                            prev.map((a) =>
                                a.category === oldName
                                    ? { ...a, category: replacement }
                                    : a,
                            ),
                        );
                    }
                    setCategories((prev) =>
                        prev.filter((c) => c.id !== deletingCategory.id),
                    );
                    setDeletingCategory(null);
                    setDeleteMoveTo("");
                };

                return (
                    <div className="animate-fade-in">
                        <div className="page-header">
                            <h1 className="page-title">Settings</h1>
                        </div>
                        <div className="settings-section">
                            <h2 className="settings-title">Data Management</h2>
                            <p
                                style={{
                                    color: "var(--text-secondary)",
                                    marginBottom: "12px",
                                }}
                            >
                                Manually trigger data sync. Use with caution.
                            </p>
                            <button
                                className="btn btn-secondary"
                                onClick={onForceSync}
                                disabled={isSyncing}
                            >
                                {isSyncing ? "‚è≥ Syncing..." : "üîÑ Force Sync"}
                            </button>
                        </div>
                        <div className="settings-section">
                            <h2 className="settings-title">
                                WhatsApp Reporting
                            </h2>
                            <div className="form-group">
                                <label className="form-label">
                                    Phone Number
                                </label>
                                <input
                                    className="form-input"
                                    type="tel"
                                    value={reportPhoneNumber}
                                    onChange={(e) =>
                                        setReportPhoneNumber(e.target.value)
                                    }
                                    placeholder="+1234567890"
                                />
                            </div>
                        </div>
                        <div className="settings-section">
                            <h2 className="settings-title">Categories</h2>
                            <div className="settings-list">
                                {categories.map((c) => (
                                    <div key={c.id} className="settings-item">
                                        <span
                                            className="settings-item-color"
                                            style={{
                                                background:
                                                    c.color || "#e8e8f0",
                                            }}
                                        ></span>
                                        <span>
                                            {c.icon} {c.name}
                                        </span>
                                        <button
                                            type="button"
                                            className="edit"
                                            title="Edit"
                                            onClick={() => startEditCategory(c)}
                                        >
                                            ‚úèÔ∏è
                                        </button>
                                        <button
                                            type="button"
                                            className="delete"
                                            title="Delete"
                                            onClick={() =>
                                                startDeleteCategory(c)
                                            }
                                        >
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                ))}
                            </div>
                            <div className="add-item-form">
                                <input
                                    type="text"
                                    value={newCat.icon}
                                    onChange={(e) =>
                                        setNewCat({
                                            ...newCat,
                                            icon: e.target.value,
                                        })
                                    }
                                    placeholder="üè∑Ô∏è"
                                    style={{
                                        maxWidth: "90px",
                                        textAlign: "center",
                                    }}
                                />
                                <input
                                    type="text"
                                    value={newCat.name}
                                    onChange={(e) =>
                                        setNewCat({
                                            ...newCat,
                                            name: e.target.value,
                                        })
                                    }
                                    placeholder="New Category Name"
                                    onKeyDown={(e) => {
                                        if (e.key === "Enter")
                                            handleAddCategory();
                                    }}
                                />
                                <button
                                    className="btn btn-secondary"
                                    onClick={handleAddCategory}
                                >
                                    Add
                                </button>
                            </div>
                        </div>
                        <div className="settings-section">
                            <h2 className="settings-title">About</h2>
                            <p>Version: {APP_VERSION}</p>
                        </div>

                        {editingCategory && (
                            <div
                                className="modal-overlay"
                                onClick={() => setEditingCategory(null)}
                            >
                                <div
                                    className="modal"
                                    style={{ maxWidth: "520px" }}
                                    onClick={(e) => e.stopPropagation()}
                                >
                                    <h2 className="modal-title">
                                        Edit Category
                                    </h2>
                                    <div className="form-row">
                                        <div className="form-group">
                                            <label className="form-label">
                                                Icon
                                            </label>
                                            <input
                                                className="form-input"
                                                value={editDraft.icon}
                                                onChange={(e) =>
                                                    setEditDraft((prev) => ({
                                                        ...prev,
                                                        icon: e.target.value,
                                                    }))
                                                }
                                                placeholder="üè∑Ô∏è"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label className="form-label">
                                                Name
                                            </label>
                                            <input
                                                className="form-input"
                                                value={editDraft.name}
                                                onChange={(e) =>
                                                    setEditDraft((prev) => ({
                                                        ...prev,
                                                        name: e.target.value,
                                                    }))
                                                }
                                                placeholder="Category name"
                                                autoFocus
                                            />
                                        </div>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">
                                            Color
                                        </label>
                                        <input
                                            type="color"
                                            value={editDraft.color}
                                            onChange={(e) =>
                                                setEditDraft((prev) => ({
                                                    ...prev,
                                                    color: e.target.value,
                                                }))
                                            }
                                            style={{
                                                width: "100%",
                                                height: "42px",
                                                padding: 0,
                                                border: "2px solid #e8e8f0",
                                                borderRadius: "12px",
                                                background: "transparent",
                                                cursor: "pointer",
                                            }}
                                        />
                                    </div>
                                    <div
                                        style={{
                                            color: "var(--text-muted)",
                                            fontSize: "12px",
                                            marginTop: "-8px",
                                        }}
                                    >
                                        Renaming updates all related activities.
                                    </div>
                                    <div className="modal-actions">
                                        <button
                                            className="btn btn-secondary"
                                            onClick={() =>
                                                setEditingCategory(null)
                                            }
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            className="btn btn-primary"
                                            onClick={saveCategoryEdit}
                                        >
                                            Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {deletingCategory && (
                            <div
                                className="modal-overlay"
                                onClick={() => setDeletingCategory(null)}
                            >
                                <div
                                    className="modal"
                                    style={{ maxWidth: "560px" }}
                                    onClick={(e) => e.stopPropagation()}
                                >
                                    <h2 className="modal-title">
                                        Delete Category
                                    </h2>
                                    <p
                                        style={{
                                            color: "var(--text-secondary)",
                                        }}
                                    >
                                        Delete{" "}
                                        <b>
                                            {deletingCategory.icon}{" "}
                                            {deletingCategory.name}
                                        </b>
                                        ?
                                    </p>

                                    {deletingCategory.usedCount > 0 && (
                                        <div className="form-group">
                                            <label className="form-label">
                                                Move{" "}
                                                {deletingCategory.usedCount}{" "}
                                                activities to
                                            </label>
                                            <select
                                                className="form-select"
                                                value={deleteMoveTo}
                                                onChange={(e) =>
                                                    setDeleteMoveTo(
                                                        e.target.value,
                                                    )
                                                }
                                            >
                                                {categories
                                                    .filter(
                                                        (c) =>
                                                            c.id !==
                                                            deletingCategory.id,
                                                    )
                                                    .map((c) => (
                                                        <option
                                                            key={c.id}
                                                            value={c.name}
                                                        >
                                                            {c.icon} {c.name}
                                                        </option>
                                                    ))}
                                            </select>
                                        </div>
                                    )}

                                    <div className="modal-actions">
                                        <button
                                            className="btn btn-secondary"
                                            onClick={() =>
                                                setDeletingCategory(null)
                                            }
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            className="btn btn-danger"
                                            onClick={confirmDeleteCategory}
                                        >
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            function Modal({
                activity,
                prefill,
                activities,
                categories,
                statuses,
                onSave,
                onClose,
            }) {
                const defaultForm = {
                    date: getLocalDateStr(),
                    timeFrom: "",
                    timeTo: "",
                    item: "",
                    category: categories[0]?.name || "",
                    status: statuses[0]?.name || "",
                    notes: "",
                };
                const [form, setForm] = useState(
                    activity || { ...defaultForm, ...(prefill || {}) },
                );
                const [suggestions, setSuggestions] = useState([]);
                const [keepOpen, setKeepOpen] = useState(false);

                const handleChange = (field, value) => {
                    setForm({ ...form, [field]: value });
                    if (field === "item" && value.length > 2) {
                        const uniqueItems = [
                            ...new Set(
                                activities.map((a) => a.item.toLowerCase()),
                            ),
                        ];
                        setSuggestions(
                            uniqueItems.filter((i) =>
                                i.includes(value.toLowerCase()),
                            ),
                        );
                    } else {
                        setSuggestions([]);
                    }
                };

                const handleSuggestionClick = (suggestion) => {
                    const existing = activities.find(
                        (a) => a.item.toLowerCase() === suggestion,
                    );
                    setForm({
                        ...form,
                        item: existing.item,
                        category: existing.category,
                    });
                    setSuggestions([]);
                };

                const handleSave = () => {
                    if (form.item.trim()) {
                        onSave(form, keepOpen);
                        if (keepOpen) {
                            const newTime = form.timeTo;
                            setForm({
                                date: form.date,
                                timeFrom: newTime,
                                timeTo: "",
                                item: "",
                                category: form.category,
                                status: form.status,
                                notes: "",
                            });
                        }
                    }
                };

                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div
                            className="modal"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h2 className="modal-title">
                                {activity ? "Edit" : "Add"} Activity
                            </h2>
                            <div className="form-group">
                                <label className="form-label">Activity</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={form.item}
                                    onChange={(e) =>
                                        handleChange("item", e.target.value)
                                    }
                                    placeholder="What did you do?"
                                    autoFocus
                                />
                                {suggestions.length > 0 && (
                                    <ul className="suggestions-list">
                                        {suggestions.map((s) => (
                                            <li
                                                key={s}
                                                onClick={() =>
                                                    handleSuggestionClick(s)
                                                }
                                            >
                                                {s}
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label className="form-label">Date</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={form.date}
                                        onChange={(e) =>
                                            handleChange("date", e.target.value)
                                        }
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">
                                        Category
                                    </label>
                                    <select
                                        className="form-select"
                                        value={form.category}
                                        onChange={(e) =>
                                            handleChange(
                                                "category",
                                                e.target.value,
                                            )
                                        }
                                    >
                                        {categories.map((c) => (
                                            <option key={c.id} value={c.name}>
                                                {c.icon} {c.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            <div className="form-row">
                                <div className="form-group">
                                    <label className="form-label">From</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={form.timeFrom}
                                        onChange={(e) =>
                                            handleChange(
                                                "timeFrom",
                                                e.target.value,
                                            )
                                        }
                                    />
                                </div>
                                <div className="form-group">
                                    <label className="form-label">To</label>
                                    <input
                                        type="time"
                                        className="form-input"
                                        value={form.timeTo}
                                        onChange={(e) =>
                                            handleChange(
                                                "timeTo",
                                                e.target.value,
                                            )
                                        }
                                    />
                                </div>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Status</label>
                                <select
                                    className="form-select"
                                    value={form.status}
                                    onChange={(e) =>
                                        handleChange("status", e.target.value)
                                    }
                                >
                                    {statuses.map((s) => (
                                        <option key={s.id} value={s.name}>
                                            {s.name}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div className="form-group">
                                <label className="form-label">Notes</label>
                                <textarea
                                    className="form-textarea"
                                    value={form.notes}
                                    onChange={(e) =>
                                        handleChange("notes", e.target.value)
                                    }
                                ></textarea>
                            </div>
                            <div className="modal-actions">
                                <label style={{ marginRight: "auto" }}>
                                    <input
                                        type="checkbox"
                                        checked={keepOpen}
                                        onChange={(e) =>
                                            setKeepOpen(e.target.checked)
                                        }
                                    />
                                    Continue adding
                                </label>
                                <button
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-primary"
                                    onClick={handleSave}
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            function BulkEditModal({
                title,
                activityIds,
                activities,
                categories,
                statuses,
                defaultCategory = "",
                defaultStatus = "",
                onEditActivity,
                onApply,
                onClose,
            }) {
                const idSet = useMemo(
                    () => new Set(activityIds || []),
                    [activityIds],
                );
                const related = useMemo(() => {
                    return (activities || []).filter((a) => idSet.has(a.id));
                }, [activities, idSet]);

                const sortedRelated = useMemo(() => {
                    const list = [...(related || [])];
                    list.sort((a, b) => {
                        const dc = String(b.date || "").localeCompare(
                            String(a.date || ""),
                        );
                        if (dc !== 0) return dc;
                        return String(b.timeFrom || "").localeCompare(
                            String(a.timeFrom || ""),
                        );
                    });
                    return list;
                }, [related]);

                const commonCategory = useMemo(() => {
                    const counts = new Map();
                    for (const a of related) {
                        const val = String(a?.category || "");
                        if (!val) continue;
                        counts.set(val, (counts.get(val) || 0) + 1);
                    }
                    return (
                        [...counts.entries()].sort(
                            (a, b) => b[1] - a[1],
                        )[0]?.[0] || ""
                    );
                }, [related]);
                const commonStatus = useMemo(() => {
                    const counts = new Map();
                    for (const a of related) {
                        const val = String(a?.status || "");
                        if (!val) continue;
                        counts.set(val, (counts.get(val) || 0) + 1);
                    }
                    return (
                        [...counts.entries()].sort(
                            (a, b) => b[1] - a[1],
                        )[0]?.[0] || ""
                    );
                }, [related]);

                const [category, setCategory] = useState(
                    defaultCategory || commonCategory || "",
                );
                const [status, setStatus] = useState(
                    defaultStatus || commonStatus || "",
                );

                useEffect(() => {
                    setCategory(defaultCategory || commonCategory || "");
                }, [defaultCategory, commonCategory]);
                useEffect(() => {
                    setStatus(defaultStatus || commonStatus || "");
                }, [defaultStatus, commonStatus]);

                const [query, setQuery] = useState("");
                const visibleRelated = useMemo(() => {
                    const q = normalizeTextForMatch(query);
                    if (!q) return sortedRelated;
                    return (sortedRelated || []).filter((a) => {
                        const hay = normalizeTextForMatch(
                            `${a.item || ""} ${a.category || ""} ${a.status || ""} ${a.notes || ""} ${a.date || ""} ${a.timeFrom || ""} ${a.timeTo || ""}`,
                        );
                        return hay.includes(q);
                    });
                }, [sortedRelated, query]);

                const apply = () => {
                    const updates = {};
                    if (category) updates.category = category;
                    if (status) updates.status = status;
                    if (Object.keys(updates).length === 0) {
                        onClose && onClose();
                        return;
                    }
                    onApply && onApply(activityIds || [], updates);
                    onClose && onClose();
                };

                return (
                    <div
                        className="modal-overlay"
                        style={{ zIndex: 990 }}
                        onClick={(e) => {
                            e.stopPropagation();
                            onClose && onClose();
                        }}
                    >
                        <div
                            className="modal"
                            style={{ maxWidth: "720px" }}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h2 className="modal-title">
                                {title || "Bulk Edit Activities"}
                            </h2>
                            <div style={{ color: "var(--text-secondary)" }}>
                                Editing <b>{related.length}</b> activities.
                            </div>

                            <div
                                className="form-row"
                                style={{ marginTop: "16px" }}
                            >
                                <div
                                    className="form-group"
                                    style={{ marginBottom: 0 }}
                                >
                                    <label className="form-label">
                                        Category
                                    </label>
                                    <select
                                        className="form-select"
                                        value={category}
                                        onChange={(e) =>
                                            setCategory(e.target.value)
                                        }
                                    >
                                        <option value="">(No change)</option>
                                        {categories.map((c) => (
                                            <option key={c.id} value={c.name}>
                                                {c.icon} {c.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div
                                    className="form-group"
                                    style={{ marginBottom: 0 }}
                                >
                                    <label className="form-label">Status</label>
                                    <select
                                        className="form-select"
                                        value={status}
                                        onChange={(e) =>
                                            setStatus(e.target.value)
                                        }
                                    >
                                        <option value="">(No change)</option>
                                        {statuses.map((s) => (
                                            <option key={s.id} value={s.name}>
                                                {s.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div className="optimizer-section">
                                <div className="optimizer-section-title">
                                    Related activities
                                </div>
                                <div
                                    style={{
                                        display: "flex",
                                        gap: "10px",
                                        alignItems: "center",
                                        margin: "10px 0 12px",
                                    }}
                                >
                                    <input
                                        className="form-input"
                                        placeholder="Filter related..."
                                        value={query}
                                        onChange={(e) =>
                                            setQuery(e.target.value)
                                        }
                                    />
                                    {query && (
                                        <button
                                            className="btn btn-secondary btn-sm"
                                            onClick={() => setQuery("")}
                                        >
                                            Clear
                                        </button>
                                    )}
                                </div>
                                <div
                                    style={{
                                        maxHeight: "220px",
                                        overflow: "auto",
                                        background: "#fafbff",
                                        border: "1px solid #eef0ff",
                                        borderRadius: "12px",
                                        padding: "10px 12px",
                                    }}
                                >
                                    {visibleRelated.length === 0 && (
                                        <div
                                            style={{
                                                color: "var(--text-muted)",
                                                padding: "6px 0",
                                            }}
                                        >
                                            No matching activities.
                                        </div>
                                    )}
                                    {(visibleRelated || []).map((a) => (
                                        <div
                                            key={a.id}
                                            style={{
                                                display: "flex",
                                                justifyContent: "space-between",
                                                gap: "12px",
                                                padding: "6px 0",
                                                borderBottom:
                                                    "1px solid rgba(0,0,0,0.04)",
                                            }}
                                        >
                                            <div
                                                style={{
                                                    overflow: "hidden",
                                                    textOverflow: "ellipsis",
                                                    whiteSpace: "nowrap",
                                                }}
                                            >
                                                <b>{a.item}</b>{" "}
                                                <span
                                                    style={{
                                                        color: "var(--text-muted)",
                                                    }}
                                                >
                                                    ({a.date} {a.timeFrom}‚Äì
                                                    {a.timeTo})
                                                </span>
                                            </div>
                                            <div
                                                style={{
                                                    display: "flex",
                                                    gap: "10px",
                                                    alignItems: "center",
                                                    whiteSpace: "nowrap",
                                                    flexShrink: 0,
                                                }}
                                            >
                                                <div
                                                    style={{
                                                        color: "var(--text-secondary)",
                                                    }}
                                                >
                                                    {a.category} ¬∑ {a.status}
                                                </div>
                                                {onEditActivity && (
                                                    <button
                                                        className="btn btn-sm btn-secondary"
                                                        onClick={() =>
                                                            onEditActivity(a)
                                                        }
                                                    >
                                                        Edit
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {query &&
                                        visibleRelated.length !==
                                            related.length && (
                                            <div
                                                style={{
                                                    paddingTop: "8px",
                                                    color: "var(--text-muted)",
                                                    fontSize: "12px",
                                                }}
                                            >
                                                Showing {visibleRelated.length}{" "}
                                                of {related.length}.
                                            </div>
                                        )}
                                </div>
                            </div>

                            <div className="modal-actions">
                                <button
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-primary"
                                    onClick={apply}
                                >
                                    Apply
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            function OptimizerModal({
                scopeActivities,
                historyActivities,
                categories,
                statuses,
                onBulkUpdate,
                onAdd,
                onEdit,
                onCreateCategory,
                onClose,
            }) {
                const computeIssues = () => {
                    const res = analyzeActivitiesOptimizer({
                        scopeActivities,
                        historyActivities,
                        categories,
                        statuses,
                    });
                    return res.issues || [];
                };

                const [ignoredIssueIds, setIgnoredIssueIds] = useState(() =>
                    (getLS(OPTIMIZER_IGNORED_KEY, []) || []).filter(Boolean),
                );
                const ignoredSet = useMemo(
                    () => new Set(ignoredIssueIds || []),
                    [ignoredIssueIds],
                );
                const ignoreIssue = (id) => {
                    if (!id) return;
                    setIgnoredIssueIds((prev) => {
                        const list = Array.isArray(prev) ? prev : [];
                        if (list.includes(id)) return list;
                        const next = [...list, id];
                        setLS(OPTIMIZER_IGNORED_KEY, next);
                        return next;
                    });
                };
                const resetIgnores = () => {
                    setIgnoredIssueIds([]);
                    setLS(OPTIMIZER_IGNORED_KEY, []);
                };

                const [issuesSnapshot, setIssuesSnapshot] = useState(() =>
                    computeIssues(),
                );

                const issues = useMemo(
                    () =>
                        (issuesSnapshot || []).filter(
                            (i) => i && i.id && !ignoredSet.has(i.id),
                        ),
                    [issuesSnapshot, ignoredSet],
                );

                const [bulkEditConfig, setBulkEditConfig] = useState(null);
                const [categoryEdits, setCategoryEdits] = useState({});
                const getEditedCategoryName = (issue, fallback) => {
                    const raw =
                        categoryEdits[issue.id] ??
                        issue.suggestedName ??
                        fallback ??
                        "";
                    return String(raw || "").trim();
                };

                const rerun = () => {
                    setIssuesSnapshot(computeIssues());
                };
                const counts = useMemo(() => {
                    const out = { error: 0, warn: 0, info: 0 };
                    for (const i of issues) {
                        out[i.severity] = (out[i.severity] || 0) + 1;
                    }
                    return out;
                }, [issues]);

                const dayCount = useMemo(() => {
                    const s = new Set(
                        (scopeActivities || [])
                            .map((a) => a.date)
                            .filter(Boolean),
                    );
                    return s.size;
                }, [scopeActivities]);

                const sections = useMemo(() => {
                    const byKind = {
                        category: [],
                        other: [],
                        time: [],
                        gap: [],
                    };
                    for (const i of issues) {
                        if (byKind[i.kind]) byKind[i.kind].push(i);
                    }
                    return [
                        {
                            key: "category",
                            title: "Category & Tagging",
                            items: [...byKind.category, ...byKind.other],
                        },
                        {
                            key: "time",
                            title: "Time Conflicts",
                            items: byKind.time,
                        },
                        { key: "gap", title: "Gaps", items: byKind.gap },
                    ].filter((s) => s.items.length > 0);
                }, [issues]);

                const severityIcon = (sev) => {
                    if (sev === "error") return "√ó";
                    if (sev === "warn") return "!";
                    return "i";
                };

                const handleAction = (issue, action) => {
                    if (!action) return;
                    if (action.kind === "createCategory") {
                        const name = getEditedCategoryName(
                            issue,
                            action.name || action.defaultName,
                        );
                        if (!name) return;
                        onCreateCategory && onCreateCategory(name);
                        return;
                    }
                    if (action.kind === "bulkEdit") {
                        setBulkEditConfig({
                            title:
                                action.title ||
                                `Manual edit related activities`,
                            ids: action.ids || [],
                            defaultCategory: action.defaultCategory || "",
                            defaultStatus: action.defaultStatus || "",
                        });
                        return;
                    }
                    if (action.kind === "applyCategory") {
                        const categoryName = getEditedCategoryName(
                            issue,
                            action.category || action.defaultName,
                        );
                        if (!categoryName) return;
                        if (action.alsoCreate && onCreateCategory) {
                            onCreateCategory(categoryName);
                        }
                        onBulkUpdate &&
                            onBulkUpdate(action.ids || [], {
                                category: categoryName,
                            });
                        return;
                    }
                    if (action.kind === "addActivity") {
                        onAdd && onAdd(action.prefill || null);
                        return;
                    }
                    if (action.kind === "editActivity") {
                        const target = (historyActivities || []).find(
                            (a) => a.id === action.activityId,
                        );
                        if (target && onEdit) onEdit(target);
                    }
                };

                return (
                    <div
                        className="modal-overlay"
                        style={{ zIndex: 980 }}
                        onClick={onClose}
                    >
                        <div
                            className="modal optimizer-modal"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h2 className="modal-title">
                                Activities Optimizer
                            </h2>
                            <div style={{ color: "var(--text-secondary)" }}>
                                Runs checks on your current Activities filters
                                using your full history for smarter suggestions.
                            </div>
                            <div className="optimizer-summary">
                                <div className="optimizer-chip">
                                    Scope: <b>{scopeActivities?.length || 0}</b>{" "}
                                    activities
                                </div>
                                <div className="optimizer-chip">
                                    Days: <b>{dayCount}</b>
                                </div>
                                <div className="optimizer-chip">
                                    Issues: <b>{issues.length}</b> ({" "}
                                    {counts.error} errors, {counts.warn} warns,{" "}
                                    {counts.info} info )
                                </div>
                                <div className="optimizer-chip">
                                    Ignored: <b>{ignoredIssueIds.length}</b>
                                </div>
                            </div>

                            {issues.length === 0 ? (
                                <div
                                    className="empty-state"
                                    style={{ margin: 0 }}
                                >
                                    <div className="empty-icon">‚úÖ</div>
                                    <h3 className="empty-title">All good!</h3>
                                    <p>No issues found in current scope.</p>
                                </div>
                            ) : (
                                sections.map((section) => (
                                    <div
                                        key={section.key}
                                        className="optimizer-section"
                                    >
                                        <div className="optimizer-section-title">
                                            {section.title}
                                        </div>
                                        <div className="issue-list">
                                            {section.items.map((issue) => (
                                                <div
                                                    key={issue.id}
                                                    className="issue-card"
                                                >
                                                    <div
                                                        className={`issue-badge ${issue.severity}`}
                                                    >
                                                        {severityIcon(
                                                            issue.severity,
                                                        )}
                                                    </div>
                                                    <div className="issue-content">
                                                        <div className="issue-title">
                                                            {issue.suggestedName
                                                                ? `New category candidate: "${getEditedCategoryName(issue, issue.suggestedName) || issue.suggestedName}"`
                                                                : issue.title}
                                                        </div>
                                                        {issue.meta && (
                                                            <div className="issue-meta">
                                                                {issue.meta}
                                                            </div>
                                                        )}
                                                        <div className="issue-details">
                                                            {Array.isArray(
                                                                issue.details,
                                                            ) ? (
                                                                <ul
                                                                    style={{
                                                                        marginLeft:
                                                                            "18px",
                                                                    }}
                                                                >
                                                                    {issue.details.map(
                                                                        (
                                                                            line,
                                                                            idx,
                                                                        ) => (
                                                                            <li
                                                                                key={`${issue.id}-${idx}`}
                                                                            >
                                                                                {
                                                                                    line
                                                                                }
                                                                            </li>
                                                                        ),
                                                                    )}
                                                                </ul>
                                                            ) : (
                                                                issue.details
                                                            )}
                                                        </div>
                                                        {issue.suggestedName && (
                                                            <div
                                                                style={{
                                                                    marginTop:
                                                                        "10px",
                                                                }}
                                                            >
                                                                <div
                                                                    style={{
                                                                        fontSize:
                                                                            "11px",
                                                                        fontWeight: 700,
                                                                        color: "var(--text-muted)",
                                                                        textTransform:
                                                                            "uppercase",
                                                                        letterSpacing:
                                                                            "0.5px",
                                                                        marginBottom:
                                                                            "6px",
                                                                    }}
                                                                >
                                                                    Category
                                                                    name
                                                                </div>
                                                                <input
                                                                    className="form-input"
                                                                    style={{
                                                                        padding:
                                                                            "10px 12px",
                                                                    }}
                                                                    value={
                                                                        categoryEdits[
                                                                            issue
                                                                                .id
                                                                        ] ??
                                                                        issue.suggestedName
                                                                    }
                                                                    onChange={(
                                                                        e,
                                                                    ) =>
                                                                        setCategoryEdits(
                                                                            (
                                                                                prev,
                                                                            ) => ({
                                                                                ...prev,
                                                                                [issue.id]:
                                                                                    e
                                                                                        .target
                                                                                        .value,
                                                                            }),
                                                                        )
                                                                    }
                                                                    placeholder="New category name"
                                                                />
                                                            </div>
                                                        )}
                                                        <div className="issue-actions">
                                                            {(
                                                                issue.actions ||
                                                                []
                                                            ).map((a, idx) => (
                                                                <button
                                                                    key={`${issue.id}-a-${idx}`}
                                                                    className="btn btn-sm btn-secondary"
                                                                    onClick={() =>
                                                                        handleAction(
                                                                            issue,
                                                                            a,
                                                                        )
                                                                    }
                                                                >
                                                                    {a.label}
                                                                </button>
                                                            ))}
                                                            <button
                                                                className="btn btn-sm btn-secondary"
                                                                onClick={() =>
                                                                    ignoreIssue(
                                                                        issue.id,
                                                                    )
                                                                }
                                                            >
                                                                Ignore
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))
                            )}

                            <div className="modal-actions">
                                <button
                                    className="btn btn-secondary"
                                    onClick={rerun}
                                >
                                    Re-run
                                </button>
                                {ignoredIssueIds.length > 0 && (
                                    <button
                                        className="btn btn-secondary"
                                        onClick={resetIgnores}
                                    >
                                        Reset ignores
                                    </button>
                                )}
                                <button
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                        {bulkEditConfig && (
                            <BulkEditModal
                                title={bulkEditConfig.title}
                                activityIds={bulkEditConfig.ids}
                                activities={historyActivities}
                                categories={categories}
                                statuses={statuses}
                                defaultCategory={bulkEditConfig.defaultCategory}
                                defaultStatus={bulkEditConfig.defaultStatus}
                                onEditActivity={onEdit}
                                onApply={(ids, updates) =>
                                    onBulkUpdate && onBulkUpdate(ids, updates)
                                }
                                onClose={() => setBulkEditConfig(null)}
                            />
                        )}
                    </div>
                );
            }

            function TokenModal({ onClose }) {
                const [token, setToken] = useState(
                    getLS("yang_github_token", ""),
                );
                return (
                    <div className="modal-overlay" onClick={onClose}>
                        <div
                            className="modal"
                            onClick={(e) => e.stopPropagation()}
                        >
                            <h2 className="modal-title">GitHub Token</h2>
                            <p>
                                A personal access token with 'repo' scope is
                                required for data sync.{" "}
                                <a
                                    href="https://github.com/settings/tokens/new"
                                    target="_blank"
                                >
                                    Create one here
                                </a>
                                .
                            </p>
                            <input
                                type="password"
                                className="form-input"
                                value={token}
                                onChange={(e) => setToken(e.target.value)}
                            />
                            <div className="modal-actions">
                                <button
                                    className="btn btn-secondary"
                                    onClick={onClose}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-primary"
                                    onClick={() => {
                                        setLS("yang_github_token", token);
                                        onClose();
                                    }}
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            function ConfirmModal({ title, message, onConfirm, onCancel }) {
                return (
                    <div className="modal-overlay">
                        <div className="modal" style={{ maxWidth: "400px" }}>
                            <h2 className="modal-title">{title}</h2>
                            <p>{message}</p>
                            <div className="modal-actions">
                                <button
                                    className="btn btn-secondary"
                                    onClick={onCancel}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-danger"
                                    onClick={onConfirm}
                                >
                                    Confirm
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            function ReportModal({ onConfirm, onCancel }) {
                const [date, setDate] = useState(getLocalDateStr());

                const handleConfirm = () => {
                    onConfirm(date);
                };

                return (
                    <div className="modal-overlay">
                        <div className="modal" style={{ maxWidth: "400px" }}>
                            <h2 className="modal-title">Select Report Date</h2>
                            <div className="form-group">
                                <input
                                    type="date"
                                    className="form-input"
                                    value={date}
                                    onChange={(e) => setDate(e.target.value)}
                                />
                            </div>
                            <div className="modal-actions">
                                <button
                                    className="btn btn-secondary"
                                    onClick={onCancel}
                                >
                                    Cancel
                                </button>
                                <button
                                    className="btn btn-primary"
                                    onClick={handleConfirm}
                                >
                                    Confirm
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            ReactDOM.render(<App />, document.getElementById("root"));
        </script>
    </body>
</html>
